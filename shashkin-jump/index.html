<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FF6B6B">
    <meta name="description" content="Прыгай как можно выше в этой увлекательной казуальной игре!">
    <link rel="manifest" href="manifest.json">
    <title>Doodle Jump Clone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a2a6c;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            height: 800px;
            margin: 0 auto;
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB, #1E90FF);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 100%;
            max-height: 100vh;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(26, 42, 108, 0.95);
            color: white;
            border-radius: 12px;
            z-index: 10;
            text-align: center;
            padding: 20px;
        }

        .screen.hidden {
            display: none;
        }

        h1 {
            font-size: 3.2rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #FF6B6B, #4ECDC4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.4rem;
            margin-bottom: 30px;
            color: #e0e0ff;
            max-width: 85%;
            line-height: 1.4;
        }

        .score-display {
            font-size: 2.5rem;
            margin: 20px 0;
            color: #FFD166;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .btn {
            background: linear-gradient(to bottom, #FF6B6B, #EE5A5A);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.6rem;
            border-radius: 50px;
            margin: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4);
            font-weight: bold;
            letter-spacing: 1px;
            touch-action: manipulation;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.6);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(to bottom, #4ECDC4, #3AADA0);
            box-shadow: 0 6px 15px rgba(78, 205, 196, 0.4);
        }

        .btn.secondary:hover {
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.6);
        }

        .instructions {
            background: rgba(30, 45, 90, 0.85);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-width: 90%;
        }

        .instructions h3 {
            color: #4ECDC4;
            margin-bottom: 10px;
            font-size: 1.6rem;
        }

        .instructions p {
            color: #e0e0ff;
            line-height: 1.5;
            font-size: 1.1rem;
        }

        .record {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: #FFD166;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.3rem;
            z-index: 5;
        }

        .touch-area {
            position: absolute;
            bottom: 0;
            height: 150px;
            width: 50%;
            z-index: 20;
        }

        #left-area {
            left: 0;
        }

        #right-area {
            right: 0;
        }

        @media (max-height: 700px) {
            #game-container {
                height: 100vh;
                max-height: 700px;
            }
            
            h1 {
                font-size: 2.6rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
                margin-bottom: 25px;
            }
            
            .btn {
                padding: 15px 45px;
                font-size: 1.4rem;
            }
        }

        @media (max-width: 400px) {
            h1 {
                font-size: 2.4rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 14px 40px;
                font-size: 1.3rem;
            }
            
            .score-display {
                font-size: 2.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="480" height="800"></canvas>
        
        <div id="menu-screen" class="screen">
            <h1>DOODLE JUMP</h1>
            <p class="subtitle">Прыгай по платформам и поднимайся как можно выше!</p>
            <button id="start-btn" class="btn">НАЧАТЬ ИГРУ</button>
            <div class="instructions">
                <h3>УПРАВЛЕНИЕ</h3>
                <p>Касайтесь левой или правой части экрана</p>
            </div>
        </div>
        
        <div id="game-over-screen" class="screen hidden">
            <h1>ИГРА ОКОНЧЕНА</h1>
            <div class="score-display">ВЫСОТА: <span id="final-score">0</span></div>
            <div class="score-display">РЕКОРД: <span id="record-score">0</span></div>
            <button id="restart-btn" class="btn">ИГРАТЬ СНОВА</button>
            <button id="menu-btn" class="btn secondary">В МЕНЮ</button>
        </div>
        
        <div id="record-display" class="record hidden">РЕКОРД: 0</div>
        
        <div id="left-area" class="touch-area"></div>
        <div id="right-area" class="touch-area"></div>
    </div>

    <script>
        // ======================
        // ИГРОВАЯ ЛОГИКА - ПОЛНОСТЬЮ ИСПРАВЛЕННАЯ
        // ======================
        
        const GAME_STATES = {
            MENU: 'menu',
            PLAYING: 'playing',
            GAME_OVER: 'game_over'
        };
        
        // Получаем канвас и контекст
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Элементы UI
        const menuScreen = document.getElementById('menu-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const recordScoreDisplay = document.getElementById('record-score');
        const recordDisplay = document.getElementById('record-display');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const menuBtn = document.getElementById('menu-btn');
        const leftArea = document.getElementById('left-area');
        const rightArea = document.getElementById('right-area');
        
        // Настройка для ретина-дисплеев
        const dpr = window.devicePixelRatio || 1;
        canvas.width = 480 * dpr;
        canvas.height = 800 * dpr;
        canvas.style.width = '480px';
        canvas.style.height = '800px';
        ctx.scale(dpr, dpr);
        
        // Игровые переменные
        let gameState = GAME_STATES.MENU;
        let platforms = [];
        let coins = [];
        let particles = [];
        let score = 0;
        let highScore = localStorage.getItem('doodleJumpHighScore') ? parseInt(localStorage.getItem('doodleJumpHighScore')) : 0;
        let cameraY = 0; // Камера (отрицательное значение = подъем)
        let lastPlayerY = 0; // Для отслеживания движения игрока
        
        // Персонаж - ИСПРАВЛЕНА ФИЗИКА
        const player = {
            x: 240, // центр канваса
            y: 650, // начальная позиция
            width: 48,
            height: 64,
            velX: 0,
            velY: 0,
            speed: 8,
            jumpPower: -16, // отрицательное значение для прыжка вверх
            gravity: 0.6,
            maxFallSpeed: 20, // максимальная скорость падения
            facingRight: true,
            onPlatform: false,
            canJump: true // флаг для предотвращения множественных прыжков
        };
        
        // Управление
        let touchLeft = false;
        let touchRight = false;
        let keys = { left: false, right: false };
        
        // Платформы
        const platformWidth = 80;
        const platformHeight = 20;
        const platformTypes = ['normal', 'moving', 'breakable', 'spring'];
        let movingPlatforms = [];
        let breakablePlatforms = [];
        let lastPlatformY = 750; // Начальная позиция последней платформы
        
        // ======================
        // ИНИЦИАЛИЗАЦИЯ ИГРЫ
        // ======================
        
        function init() {
            // Показать рекорд
            recordScoreDisplay.textContent = highScore;
            recordDisplay.textContent = `РЕКОРД: ${highScore}`;
            
            // Обработчики событий
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            menuBtn.addEventListener('click', showMenu);
            
            // Управление с клавиатуры
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            });
            
            // Управление касанием
            leftArea.addEventListener('touchstart', (e) => { e.preventDefault(); touchLeft = true; });
            leftArea.addEventListener('touchend', (e) => { e.preventDefault(); touchLeft = false; });
            leftArea.addEventListener('touchcancel', (e) => { e.preventDefault(); touchLeft = false; });
            leftArea.addEventListener('touchmove', (e) => { e.preventDefault(); });
            
            rightArea.addEventListener('touchstart', (e) => { e.preventDefault(); touchRight = true; });
            rightArea.addEventListener('touchend', (e) => { e.preventDefault(); touchRight = false; });
            rightArea.addEventListener('touchcancel', (e) => { e.preventDefault(); touchRight = false; });
            rightArea.addEventListener('touchmove', (e) => { e.preventDefault(); });
            
            // Генерация начальных платформ
            generateInitialPlatforms();
            
            // Запуск игрового цикла
            gameLoop();
        }
        
        // ======================
        // ГЕНЕРАЦИЯ ПЛАТФОРМ И МОНЕТ
        // ======================
        
        function generateInitialPlatforms() {
            platforms = [];
            coins = [];
            movingPlatforms = [];
            breakablePlatforms = [];
            particles = [];
            
            // Начальная платформа под игроком
            platforms.push({
                x: 200,
                y: 750,
                width: platformWidth,
                height: platformHeight,
                type: 'normal'
            });
            
            // Генерация остальных платформ
            lastPlatformY = 750;
            for (let i = 0; i < 14; i++) {
                generatePlatform();
            }
            
            // Генерация монет
            for (let i = 0; i < 8; i++) {
                generateCoin();
            }
        }
        
        function generatePlatform() {
            const padding = 30;
            const minY = lastPlatformY - 160;
            const maxY = lastPlatformY - 90;
            const y = Math.random() * (maxY - minY) + minY;
            const x = Math.random() * (480 - platformWidth - padding * 2) + padding;
            
            // Больше нормальных платформ, реже специальные
            const type = Math.random() > 0.7 ? platformTypes[Math.floor(Math.random() * platformTypes.length)] : 'normal';
            
            const platform = {
                x: x,
                y: y,
                width: platformWidth,
                height: platformHeight,
                type: type
            };
            
            // Для движущихся платформ
            if (type === 'moving') {
                platform.direction = Math.random() > 0.5 ? 1 : -1;
                platform.speed = 1.5 + Math.random() * 1.5;
                platform.minX = padding;
                platform.maxX = 480 - platformWidth - padding;
                movingPlatforms.push(platform);
            }
            
            // Для разрушаемых платформ
            if (type === 'breakable') {
                platform.health = 3;
                breakablePlatforms.push(platform);
            }
            
            platforms.push(platform);
            lastPlatformY = y;
        }
        
        function generateCoin() {
            const padding = 30;
            const x = Math.random() * (480 - 40 - padding * 2) + padding;
            const y = Math.random() * 1200 - 400;
            
            coins.push({
                x: x,
                y: y,
                width: 25,
                height: 25,
                collected: false
            });
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: 2 + Math.random() * 4,
                    speedX: -2 + Math.random() * 4,
                    speedY: -3 - Math.random() * 2,
                    color: color,
                    life: 25 + Math.random() * 10
                });
            }
        }
        
        // ======================
        // ФИЗИКА И КОЛЛИЗИИ - ПОЛНОСТЬЮ ПЕРЕПИСАНЫ
        // ======================
        
        function checkPlatformCollision() {
            player.onPlatform = false;
            player.canJump = true;
            
            for (let i = platforms.length - 1; i >= 0; i--) {
                const p = platforms[i];
                const playerBottom = player.y + player.height;
                const platformTop = p.y;
                const platformBottom = p.y + p.height;
                
                // Проверяем, что игрок находится над платформой
                const isAbovePlatform = player.x + player.width > p.x && 
                                       player.x < p.x + p.width &&
                                       playerBottom >= platformTop &&
                                       playerBottom <= platformTop + 20; // допуск 20 пикселей
                
                // Проверяем, что игрок падает вниз (или стоит на месте)
                const isFallingOrLanding = player.velY >= 0;
                
                // Проверяем, что игрок не проходит сквозь платформу снизу
                const notComingFromBelow = player.y < platformBottom;
                
                if (isAbovePlatform && isFallingOrLanding && notComingFromBelow) {
                    // Игрок приземлился на платформу
                    
                    // Обработка разных типов платформ
                    if (p.type === 'breakable') {
                        p.health--;
                        if (p.health <= 0) {
                            createParticles(p.x + p.width/2, p.y, 8, '#FF6B6B');
                            platforms.splice(i, 1);
                            const idx = breakablePlatforms.indexOf(p);
                            if (idx > -1) breakablePlatforms.splice(idx, 1);
                            continue;
                        }
                    } else if (p.type === 'spring') {
                        player.velY = player.jumpPower * 1.8; // сильнее прыжок
                        player.canJump = false; // предотвращаем повторный прыжок
                        createParticles(player.x + player.width/2, player.y + player.height, 12, '#4ECDC4');
                    } else {
                        player.velY = player.jumpPower; // обычный прыжок
                        player.canJump = false; // предотвращаем повторный прыжок
                        createParticles(player.x + player.width/2, player.y + player.height, 6, '#FFD166');
                    }
                    
                    player.onPlatform = true;
                    player.y = platformTop - player.height; // точно позиционируем игрока
                    
                    // Движение вместе с движущейся платформой
                    if (p.type === 'moving') {
                        player.x += p.speed * p.direction;
                    }
                }
            }
        }
        
        function update() {
            if (gameState !== GAME_STATES.PLAYING) return;
            
            // Сохраняем предыдущую позицию для камеры
            lastPlayerY = player.y;
            
            // Горизонтальное движение
            player.velX = 0;
            
            if (keys.left || touchLeft) {
                player.velX = -player.speed;
                player.facingRight = false;
            }
            
            if (keys.right || touchRight) {
                player.velX = player.speed;
                player.facingRight = true;
            }
            
            // Обновление позиции игрока
            player.x += player.velX;
            
            // Применение гравитации (только если не на платформе)
            if (!player.onPlatform) {
                player.velY += player.gravity;
                // Ограничение максимальной скорости падения
                if (player.velY > player.maxFallSpeed) {
                    player.velY = player.maxFallSpeed;
                }
            }
            
            player.y += player.velY;
            
            // Ограничение по горизонтали (телепортация)
            if (player.x + player.width < 0) {
                player.x = 480;
            } else if (player.x > 480) {
                player.x = -player.width;
            }
            
            // Проверка коллизий с платформами
            checkPlatformCollision();
            
            // Проверка столкновений с монетами
            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (!c.collected &&
                    player.x + player.width > c.x &&
                    player.x < c.x + c.width &&
                    player.y + player.height > c.y &&
                    player.y < c.y + c.height) {
                    
                    c.collected = true;
                    score += 10;
                    createParticles(c.x + c.width/2, c.y + c.height/2, 8, '#FFD166');
                    coins.splice(i, 1);
                    generateCoin(); // Генерируем новую монету
                }
            }
            
            // Обновление движущихся платформ
            for (let i = 0; i < movingPlatforms.length; i++) {
                const p = movingPlatforms[i];
                p.x += p.speed * p.direction;
                if (p.x <= p.minX || p.x + p.width >= p.maxX) {
                    p.direction *= -1;
                }
            }
            
            // Обновление частиц
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX;
                p.y += p.speedY;
                p.speedY += 0.15; // гравитация для частиц
                p.life--;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            // УПРАВЛЕНИЕ КАМЕРОЙ - ИСПРАВЛЕНО
            const cameraThreshold = 300; // Порог для движения камеры
            
            // Камера следует за игроком только когда он поднимается выше порога
            if (player.y < cameraThreshold) {
                const cameraMoveAmount = cameraThreshold - player.y;
                cameraY -= cameraMoveAmount;
                player.y = cameraThreshold;
                
                // Обновление счета (высота = -cameraY)
                score = Math.floor(-cameraY / 10);
                
                // Генерация новых платформ при подъеме
                if (cameraY < lastPlatformY - 800) {
                    generatePlatform();
                }
            }
            
            // Удаление старых платформ и монет
            platforms = platforms.filter(p => p.y - cameraY < 900);
            coins = coins.filter(c => c.y - cameraY < 900 && !c.collected);
            
            // Проверка окончания игры (падение вниз)
            if (player.y > 900) {
                gameOver();
            }
        }
        
        // ======================
        // ОТРИСОВКА
        // ======================
        
        function drawBackground() {
            // Градиентный фон
            const gradient = ctx.createLinearGradient(0, 0, 0, 800);
            const skyTop = Math.min(255, Math.max(0, 100 + cameraY / 20));
            const skyBottom = Math.min(255, Math.max(0, 180 + cameraY / 20));
            gradient.addColorStop(0, `rgb(30, ${skyTop}, 255)`);
            gradient.addColorStop(1, `rgb(30, ${skyBottom}, 200)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 480, 800);
            
            // Солнце/луна в зависимости от высоты
            const sunY = 100 - cameraY * 0.1;
            if (sunY > -100 && sunY < 900) {
                ctx.fillStyle = cameraY < -2000 ? '#CCCCCC' : '#FFD166';
                ctx.beginPath();
                ctx.arc(400, sunY, 40, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Облака
            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            drawCloud(100, 150 - cameraY * 0.05, 25);
            drawCloud(300, 80 - cameraY * 0.07, 30);
            drawCloud(150, 250 - cameraY * 0.03, 20);
            drawCloud(400, 200 - cameraY * 0.06, 28);
        }
        
        function drawCloud(x, y, size) {
            if (y > 850 || y < -100) return;
            
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.arc(x + size * 0.9, y - size * 0.4, size * 0.8, 0, Math.PI * 2);
            ctx.arc(x + size * 1.7, y, size * 0.9, 0, Math.PI * 2);
            ctx.arc(x + size * 0.8, y + size * 0.4, size * 0.7, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawPlatform(platform) {
            const y = platform.y - cameraY;
            if (y > 850 || y < -100) return;
            
            // Цвет в зависимости от типа
            switch(platform.type) {
                case 'normal': ctx.fillStyle = '#7986CB'; break;
                case 'moving': ctx.fillStyle = '#4DB6AC'; break;
                case 'breakable': 
                    const healthRatio = platform.health / 3;
                    ctx.fillStyle = `rgb(${220 - healthRatio * 100}, ${80 + healthRatio * 100}, 80)`;
                    break;
                case 'spring': ctx.fillStyle = '#4DB6AC'; break;
                default: ctx.fillStyle = '#7986CB';
            }
            
            // Основная платформа
            ctx.fillRect(platform.x, y, platform.width, platform.height);
            
            // Детали
            ctx.fillStyle = '#3F51B5';
            ctx.fillRect(platform.x, y + platform.height - 4, platform.width, 4);
            
            // Пружина
            if (platform.type === 'spring') {
                ctx.fillStyle = '#FF7043';
                const springWidth = platform.width * 0.4;
                const springHeight = platform.height * 1.8;
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2, 
                    y - springHeight, 
                    springWidth, 
                    springHeight
                );
                
                // Детали пружины
                ctx.fillStyle = '#BF360C';
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2 + 3, 
                    y - springHeight + 3, 
                    springWidth - 6, 
                    3
                );
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2 + 3, 
                    y - springHeight/2, 
                    springWidth - 6, 
                    3
                );
            }
        }
        
        function drawCoin(coin) {
            const y = coin.y - cameraY;
            if (y > 850 || y < -100 || coin.collected) return;
            
            // Монета
            ctx.fillStyle = '#FFD166';
            ctx.beginPath();
            ctx.arc(coin.x + coin.width/2, y + coin.height/2, coin.width/2 - 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Блеск
            ctx.fillStyle = '#FFF9C4';
            ctx.beginPath();
            ctx.arc(coin.x + coin.width/2 - 4, y + coin.height/2 - 4, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawPlayer() {
            const y = player.y - cameraY;
            
            // Тело
            ctx.fillStyle = player.facingRight ? '#FF6B6B' : '#4ECDC4';
            ctx.fillRect(player.x, y, player.width, player.height * 0.8);
            
            // Голова
            ctx.fillStyle = '#FFD9B3';
            ctx.fillRect(player.x + 8, y - 16, player.width - 16, 24);
            
            // Глаза
            ctx.fillStyle = '#000000';
            if (player.facingRight) {
                ctx.fillRect(player.x + 26, y - 10, 6, 8);
                ctx.fillRect(player.x + 36, y - 10, 6, 8);
            } else {
                ctx.fillRect(player.x + 10, y - 10, 6, 8);
                ctx.fillRect(player.x + 20, y - 10, 6, 8);
            }
            
            // Рот (улыбка при прыжке вверх, нейтральный при падении)
            ctx.fillStyle = '#E74C3C';
            if (player.velY < -2) {
                // Улыбка при прыжке
                ctx.beginPath();
                ctx.arc(player.x + 24, y + 2, 10, 0, Math.PI);
                ctx.fill();
            } else if (player.velY > 2) {
                // Хмурый рот при падении
                ctx.beginPath();
                ctx.arc(player.x + 24, y + 8, 10, Math.PI, Math.PI * 2);
                ctx.fill();
            } else {
                // Нейтральный рот
                ctx.fillRect(player.x + 20, y + 4, 16, 3);
            }
            
            // Ноги
            ctx.fillStyle = '#3498DB';
            ctx.fillRect(player.x + 10, y + player.height * 0.8 - 5, 10, 12);
            ctx.fillRect(player.x + 28, y + player.height * 0.8 - 5, 10, 12);
        }
        
        function drawParticles() {
            particles.forEach(p => {
                if (p.y - cameraY > 850 || p.y - cameraY < -100) return;
                
                ctx.globalAlpha = p.life / 35;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y - cameraY, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }
        
        function drawScore() {
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`ВЫСОТА: ${score}`, 240, 50);
            
            if (score < highScore) {
                ctx.fillStyle = '#FFD166';
                ctx.font = 'bold 22px Arial';
                ctx.fillText(`РЕКОРД: ${highScore}`, 240, 90);
            }
        }
        
        function draw() {
            ctx.clearRect(0, 0, 480, 800);
            
            // Фон
            drawBackground();
            
            // Платформы
            platforms.forEach(drawPlatform);
            
            // Монеты
            coins.forEach(drawCoin);
            
            // Частицы
            drawParticles();
            
            // Персонаж
            drawPlayer();
            
            // Счет
            if (gameState === GAME_STATES.PLAYING) {
                drawScore();
            }
        }
        
        // ======================
        // ИГРОВОЙ ЦИКЛ И СОСТОЯНИЯ
        // ======================
        
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            menuScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            recordDisplay.classList.remove('hidden');
            gameState = GAME_STATES.PLAYING;
            
            // Сброс переменных
            score = 0;
            cameraY = 0;
            player.x = 240;
            player.y = 650;
            player.velX = 0;
            player.velY = 0;
            player.facingRight = true;
            player.onPlatform = false;
            player.canJump = true;
            
            generateInitialPlatforms();
        }
        
        function restartGame() {
            gameOverScreen.classList.add('hidden');
            gameState = GAME_STATES.PLAYING;
            
            // Сброс переменных
            score = 0;
            cameraY = 0;
            player.x = 240;
            player.y = 650;
            player.velX = 0;
            player.velY = 0;
            player.facingRight = true;
            player.onPlatform = false;
            player.canJump = true;
            
            generateInitialPlatforms();
        }
        
        function showMenu() {
            gameOverScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
            recordDisplay.classList.add('hidden');
            gameState = GAME_STATES.MENU;
        }
        
        function gameOver() {
            gameState = GAME_STATES.GAME_OVER;
            
            // Обновление рекорда
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('doodleJumpHighScore', highScore);
            }
            
            // Обновление отображения
            finalScoreDisplay.textContent = score;
            recordScoreDisplay.textContent = highScore;
            recordDisplay.textContent = `РЕКОРД: ${highScore}`;
            
            gameOverScreen.classList.remove('hidden');
        }
        
        // ======================
        // ЗАПУСК ИГРЫ
        // ======================
        
        window.addEventListener('load', () => {
            init();
        });
    </script>
</body>
</html>