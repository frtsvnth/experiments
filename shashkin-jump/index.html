<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="theme-color" content="#FF6B6B">
	<meta name="description" content="Прыгай как можно выше в этой увлекательной казуальной игре!">
	<link rel="manifest" href="manifest.json">
	<title>Doodle Jump Clone</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #1a2a6c;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			overflow: hidden;
			touch-action: none;
			width: 100%;
			height: 100vh;
			margin: 0;
			padding: 0;
		}

		#game-container {
			position: relative;
			width: 100%;
			max-width: 480px;
			max-height: 800px;
			margin: 0 auto;
			height: 0;
			padding-bottom: 166.6667%;
			/* 800/480 = 1.666667 для сохранения соотношения сторон */
		}

		canvas {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: block;
			background: linear-gradient(to bottom, #87CEEB, #1E90FF);
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			image-rendering: optimizeSpeed;
			image-rendering: -moz-crisp-edges;
			image-rendering: -webkit-optimize-contrast;
			image-rendering: -o-crisp-edges;
			image-rendering: pixelated;
		}

		.screen {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			background: rgba(26, 42, 108, 0.95);
			color: white;
			border-radius: 12px;
			z-index: 10;
			text-align: center;
			padding: 5%;
		}

		.screen.hidden {
			display: none;
		}

		h1 {
			font-size: 7.5vmin;
			margin-bottom: 3.5vmin;
			text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
			background: linear-gradient(to right, #FF6B6B, #4ECDC4);
			-webkit-background-clip: text;
			background-clip: text;
			color: transparent;
			letter-spacing: 2px;
		}

		.subtitle {
			font-size: 3.2vmin;
			margin-bottom: 5vmin;
			color: #e0e0ff;
			max-width: 85%;
			line-height: 1.4;
		}

		.score-display {
			font-size: 5.5vmin;
			margin: 3vmin 0;
			color: #FFD166;
			font-weight: bold;
			text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
		}

		.btn {
			background: linear-gradient(to bottom, #FF6B6B, #EE5A5A);
			color: white;
			border: none;
			padding: 3.2vmin 8vmin;
			font-size: 3.5vmin;
			border-radius: 50px;
			margin: 2.5vmin;
			cursor: pointer;
			transition: all 0.2s ease;
			box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
			font-weight: bold;
			letter-spacing: 1px;
			touch-action: manipulation;
			min-width: 35%;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(255, 107, 107, 0.6);
		}

		.btn:active {
			transform: translateY(2px);
			box-shadow: 0 3px 8px rgba(255, 107, 107, 0.4);
		}

		.btn.secondary {
			background: linear-gradient(to bottom, #4ECDC4, #3AADA0);
			box-shadow: 0 4px 12px rgba(78, 205, 196, 0.4);
		}

		.btn.secondary:hover {
			box-shadow: 0 6px 16px rgba(78, 205, 196, 0.6);
		}

		.instructions {
			background: rgba(30, 45, 90, 0.85);
			border-radius: 15px;
			padding: 4vmin;
			margin-top: 3vmin;
			max-width: 90%;
		}

		.instructions h3 {
			color: #4ECDC4;
			margin-bottom: 2vmin;
			font-size: 3.5vmin;
		}

		.instructions p {
			color: #e0e0ff;
			line-height: 1.5;
			font-size: 2.8vmin;
		}

		.record {
			position: absolute;
			top: 2.5vmin;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.6);
			color: #FFD166;
			padding: 1.2vmin 2.5vmin;
			border-radius: 20px;
			font-weight: bold;
			font-size: 2.8vmin;
			z-index: 5;
		}

		.touch-area {
			position: absolute;
			bottom: 0;
			height: 18.75%;
			/* 150/800 = 0.1875 */
			width: 50%;
			z-index: 20;
		}

		#left-area {
			left: 0;
		}

		#right-area {
			right: 0;
		}

		@media (max-height: 700px) {
			.screen {
				padding: 3%;
			}

			h1 {
				font-size: 7vmin;
			}

			.subtitle {
				font-size: 3vmin;
				margin-bottom: 4.5vmin;
			}

			.btn {
				padding: 2.8vmin 7vmin;
				font-size: 3.2vmin;
			}
		}

		@media (max-width: 400px) {
			h1 {
				font-size: 6.8vmin;
			}

			.subtitle {
				font-size: 2.9vmin;
			}

			.btn {
				padding: 2.6vmin 6.5vmin;
				font-size: 3vmin;
				min-width: 40%;
			}

			.score-display {
				font-size: 5vmin;
			}

			.instructions {
				padding: 3.5vmin;
			}
		}
	</style>
</head>

<body>
	<div id="game-container">
		<canvas id="gameCanvas"></canvas>

		<div id="menu-screen" class="screen">
			<h1>DOODLE JUMP</h1>
			<p class="subtitle">Прыгай по платформам и поднимайся как можно выше!</p>
			<button id="start-btn" class="btn">НАЧАТЬ ИГРУ</button>
			<div class="instructions">
				<h3>УПРАВЛЕНИЕ</h3>
				<p>Касайтесь левой или правой части экрана</p>
			</div>
		</div>

		<div id="game-over-screen" class="screen hidden">
			<h1>ИГРА ОКОНЧЕНА</h1>
			<div class="score-display">ВЫСОТА: <span id="final-score">0</span></div>
			<div class="score-display">РЕКОРД: <span id="record-score">0</span></div>
			<button id="restart-btn" class="btn">ИГРАТЬ СНОВА</button>
			<button id="menu-btn" class="btn secondary">В МЕНЮ</button>
		</div>

		<div id="record-display" class="record hidden">РЕКОРД: 0</div>

		<div id="left-area" class="touch-area"></div>
		<div id="right-area" class="touch-area"></div>
	</div>

	<script>
		// ======================
        // ИГРОВАЯ ЛОГИКА - ПОЛНОСТЬЮ АДАПТИВНАЯ
        // ======================
        
        const GAME_STATES = {
            MENU: 'menu',
            PLAYING: 'playing',
            GAME_OVER: 'game_over'
        };
        
        // Константы игрового мира (виртуальные координаты)
        const GAME_WIDTH = 480;
        const GAME_HEIGHT = 800;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const menuScreen = document.getElementById('menu-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreDisplay = document.getElementById('final-score');
        const recordScoreDisplay = document.getElementById('record-score');
        const recordDisplay = document.getElementById('record-display');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const menuBtn = document.getElementById('menu-btn');
        const leftArea = document.getElementById('left-area');
        const rightArea = document.getElementById('right-area');
        
        // Масштабирование и размеры
        let scaleX = 1;
        let scaleY = 1;
        let offsetX = 0;
        let offsetY = 0;
        const dpr = window.devicePixelRatio || 1;
        
        // Инициализация размеров
        function setupCanvas() {
            const container = document.getElementById('game-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Установка размеров canvas в пикселях
            canvas.width = containerWidth * dpr;
            canvas.height = containerHeight * dpr;
            
            // Расчет коэффициентов масштабирования
            scaleX = canvas.width / GAME_WIDTH / dpr;
            scaleY = canvas.height / GAME_HEIGHT / dpr;
            
            // Центрирование игрового мира
            if (scaleX < scaleY) {
                // Ограничено по ширине
                offsetX = 0;
                offsetY = (canvas.height / dpr - GAME_HEIGHT * scaleX) / 2;
                scaleY = scaleX;
            } else {
                // Ограничено по высоте
                offsetX = (canvas.width / dpr - GAME_WIDTH * scaleY) / 2;
                offsetY = 0;
                scaleX = scaleY;
            }
            
            // Применение масштабирования к контексту
            ctx.setTransform(dpr * scaleX, 0, 0, dpr * scaleY, dpr * offsetX, dpr * offsetY);
        }
        
        // Обработчик изменения размера окна
        window.addEventListener('resize', () => {
            setupCanvas();
        });
        
        // Инициализация размеров при загрузке
        setupCanvas();
        
        let gameState = GAME_STATES.MENU;
        let platforms = [];
        let coins = [];
        let particles = [];
        let score = 0;
        let highScore = localStorage.getItem('doodleJumpHighScore') ? parseInt(localStorage.getItem('doodleJumpHighScore')) : 0;
        
        // ПЛАВНАЯ КАМЕРА
        let cameraY = 0;
        let cameraTargetY = 0;
        
        let platformIdCounter = 0;
        let currentPlatformId = null;
        let nextPlatformY = 750;
        let lastGeneratedHeight = 0;
        let lastGeneratedCoinHeight = 0;
        
        const player = {
            x: GAME_WIDTH / 2,
            y: 650,
            width: 48,
            height: 64,
            velX: 0,
            velY: 0,
            speed: 8,
            jumpPower: -16,
            gravity: 0.6,
            maxFallSpeed: 20,
            facingRight: true,
            grounded: false,
            justJumped: false
        };
        
        let touchLeft = false;
        let touchRight = false;
        let keys = { left: false, right: false };
        
        const platformWidth = 80;
        const platformHeight = 20;
        const platformTypes = ['normal', 'moving', 'breakable', 'spring'];
        let movingPlatforms = [];
        let breakablePlatforms = [];
        
        // ======================
        // ИНИЦИАЛИЗАЦИЯ ИГРЫ
        // ======================
        
        function init() {
            recordScoreDisplay.textContent = highScore;
            recordDisplay.textContent = `РЕКОРД: ${highScore}`;
            
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            menuBtn.addEventListener('click', showMenu);
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            });
            
            leftArea.addEventListener('touchstart', (e) => { e.preventDefault(); touchLeft = true; });
            leftArea.addEventListener('touchend', (e) => { e.preventDefault(); touchLeft = false; });
            leftArea.addEventListener('touchcancel', (e) => { e.preventDefault(); touchLeft = false; });
            
            rightArea.addEventListener('touchstart', (e) => { e.preventDefault(); touchRight = true; });
            rightArea.addEventListener('touchend', (e) => { e.preventDefault(); touchRight = false; });
            rightArea.addEventListener('touchcancel', (e) => { e.preventDefault(); touchRight = false; });
            
            generateInitialPlatforms();
            gameLoop();
        }
        
        // ======================
        // ГЕНЕРАЦИЯ ПЛАТФОРМ И МОНЕТ
        // ======================
        
        function generateInitialPlatforms() {
            platforms = [];
            coins = [];
            movingPlatforms = [];
            breakablePlatforms = [];
            particles = [];
            platformIdCounter = 0;
            currentPlatformId = null;
            nextPlatformY = 750;
            lastGeneratedHeight = 0;
            lastGeneratedCoinHeight = 0;
            cameraY = 0;
            cameraTargetY = 0;
            
            // === ЦЕНТРАЛЬНАЯ НАЧАЛЬНАЯ ПЛАТФОРМА ===
            platforms.push({
                id: platformIdCounter++,
                x: 200,
                y: 750,
                width: platformWidth,
                height: platformHeight,
                type: 'normal'
            });
            
            // Генерируем платформы от низа вверх
            for (let y = 630; y > -1500; y -= 120) {
                generatePlatformAtY(y);
            }
            
            // Генерируем начальные монеты
            for (let y = 700; y > -1500; y -= 80) {
                generateCoinAtY(y);
            }
        }
        
        function generatePlatformAtY(y) {
            const padding = 30;
            const x = Math.random() * (GAME_WIDTH - platformWidth - padding * 2) + padding;
            
            const type = Math.random() > 0.8 ? platformTypes[Math.floor(Math.random() * platformTypes.length)] : 'normal';
            
            const platform = {
                id: platformIdCounter++,
                x: x,
                y: y,
                width: platformWidth,
                height: platformHeight,
                type: type
            };
            
            if (type === 'moving') {
                platform.direction = Math.random() > 0.5 ? 1 : -1;
                platform.speed = 1.5 + Math.random() * 1.5;
                platform.minX = padding;
                platform.maxX = GAME_WIDTH - platformWidth - padding;
                movingPlatforms.push(platform);
            }
            
            if (type === 'breakable') {
                platform.health = 3;
                breakablePlatforms.push(platform);
            }
            
            platforms.push(platform);
            
            if (y < nextPlatformY) {
                nextPlatformY = y;
            }
        }
        
        function generateCoinAtY(y) {
            const padding = 30;
            const x = Math.random() * (GAME_WIDTH - 40 - padding * 2) + padding;
            
            coins.push({
                x: x,
                y: y,
                width: 25,
                height: 25,
                collected: false
            });
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: 2 + Math.random() * 4,
                    speedX: -2 + Math.random() * 4,
                    speedY: -3 - Math.random() * 2,
                    color: color,
                    life: 25 + Math.random() * 10
                });
            }
        }
        
        // ======================
        // ФИЗИКА И КОЛЛИЗИИ
        // ======================
        
        function checkCollisions() {
            player.grounded = false;
            let landedOnPlatformId = null;
            let landedPlatformY = null;
            
            // Сначала обновляем позицию по вертикали
            player.y += player.velY;
            
            for (let i = platforms.length - 1; i >= 0; i--) {
                const p = platforms[i];
                
                const playerTop = player.y;
                const playerBottom = player.y + player.height;
                const playerLeft = player.x;
                const playerRight = player.x + player.width;
                
                const platformTop = p.y;
                const platformBottom = p.y + p.height;
                const platformLeft = p.x;
                const platformRight = p.x + p.width;
                
                const horizontalOverlap = playerRight > platformLeft && playerLeft < platformRight;
                
                if (!horizontalOverlap) continue;
                
                // === СЛУЧАЙ 1: Приземление на платформу сверху ===
                if (player.velY > 0 && 
                    playerBottom - player.velY <= platformTop && 
                    playerBottom >= platformTop) {
                    
                    player.y = platformTop - player.height;
                    player.velY = player.jumpPower;
                    player.grounded = true;
                    player.justJumped = true;
                    landedOnPlatformId = p.id;
                    landedPlatformY = p.y;
                    
                    if (p.type === 'breakable') {
                        p.health--;
                        if (p.health <= 0) {
                            createParticles(p.x + p.width/2, p.y, 8, '#FF6B6B');
                            platforms.splice(i, 1);
                            const idx = breakablePlatforms.indexOf(p);
                            if (idx > -1) breakablePlatforms.splice(idx, 1);
                            continue;
                        }
                    } else if (p.type === 'spring') {
                        player.velY = player.jumpPower * 1.8;
                        createParticles(player.x + player.width/2, player.y + player.height, 12, '#4ECDC4');
                    } else {
                        createParticles(player.x + player.width/2, player.y + player.height, 6, '#FFD166');
                    }
                    
                    if (p.type === 'moving') {
                        player.x += p.speed * p.direction;
                    }
                    
                    continue;
                }
            }
            
            // === ОБНОВЛЕНИЕ КАМЕРЫ ПРИ СМЕНЕ ПЛАТФОРМЫ ===
            if (landedOnPlatformId !== null && landedOnPlatformId !== currentPlatformId) {
                currentPlatformId = landedOnPlatformId;
                cameraTargetY = (landedPlatformY - 750);
                score = Math.floor(-cameraTargetY / 10);
            }
            
            // === ПЛАВНОЕ ДВИЖЕНИЕ КАМЕРЫ ===
            if (Math.abs(cameraTargetY - cameraY) > 0.5) {
                cameraY += (cameraTargetY - cameraY) * 0.2;
            } else {
                cameraY = cameraTargetY;
            }
            
            // === ГЕНЕРАЦИЯ НОВЫХ ПЛАТФОРМ ===
            const playerWorldY = player.y + cameraY;
            const generateThreshold = 200;
            
            if (playerWorldY < lastGeneratedHeight - generateThreshold) {
                const platformsPerBlock = 10;
                const spacing = 100;
                
                for (let i = 0; i < platformsPerBlock; i++) {
                    const newY = nextPlatformY - spacing;
                    generatePlatformAtY(newY);
                }
                
                lastGeneratedHeight = playerWorldY;
            }
            
            // === ГЕНЕРАЦИЯ НОВЫХ МОНЕТ ===
            if (playerWorldY < lastGeneratedCoinHeight - generateThreshold) {
                const coinsPerBlock = 8;
                const coinSpacing = 80;
                
                for (let i = 0; i < coinsPerBlock; i++) {
                    const newY = nextPlatformY - coinSpacing - (i * coinSpacing);
                    generateCoinAtY(newY);
                }
                
                lastGeneratedCoinHeight = playerWorldY;
            }
            
            // === ПРОВЕРКА ГЕЙМОВЕРА ===
            const gameOverThreshold = cameraY + 800;
            if (player.y + cameraY > gameOverThreshold) {
                gameOver();
                return;
            }
            
            // Применение гравитации
            if (!player.grounded) {
                player.velY += player.gravity;
                if (player.velY > player.maxFallSpeed) {
                    player.velY = player.maxFallSpeed;
                }
                player.justJumped = false;
            }
            
            // Горизонтальное движение
            player.x += player.velX;
            
            // Ограничение по горизонтали (телепортация)
            if (player.x + player.width < 0) {
                player.x = GAME_WIDTH;
            } else if (player.x > GAME_WIDTH) {
                player.x = -player.width;
            }
        }
        
        function update() {
            if (gameState !== GAME_STATES.PLAYING) return;
            
            player.velX = 0;
            
            if (keys.left || touchLeft) {
                player.velX = -player.speed;
                player.facingRight = false;
            }
            
            if (keys.right || touchRight) {
                player.velX = player.speed;
                player.facingRight = true;
            }
            
            checkCollisions();
            
            // Проверка столкновений с монетами
            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (!c.collected &&
                    player.x + player.width > c.x &&
                    player.x < c.x + c.width &&
                    player.y + player.height > c.y &&
                    player.y < c.y + c.height) {
                    
                    c.collected = true;
                    score += 10;
                    createParticles(c.x + c.width/2, c.y + c.height/2, 8, '#FFD166');
                    coins.splice(i, 1);
                }
            }
            
            // Обновление движущихся платформ
            for (let i = 0; i < movingPlatforms.length; i++) {
                const p = movingPlatforms[i];
                p.x += p.speed * p.direction;
                if (p.x <= p.minX || p.x + p.width >= p.maxX) {
                    p.direction *= -1;
                }
            }
            
            // Обновление частиц
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX;
                p.y += p.speedY;
                p.speedY += 0.15;
                p.life--;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            // Удаляем старые платформы и монеты
            const removeThreshold = cameraY + 800;
            
            platforms = platforms.filter(p => p.y < removeThreshold);
            coins = coins.filter(c => c.y < removeThreshold && !c.collected);
        }
        
        // ======================
        // ОТРИСОВКА
        // ======================
        
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, GAME_HEIGHT);
            const skyTop = Math.min(255, Math.max(0, 100 + cameraY / 20));
            const skyBottom = Math.min(255, Math.max(0, 180 + cameraY / 20));
            gradient.addColorStop(0, `rgb(30, ${skyTop}, 255)`);
            gradient.addColorStop(1, `rgb(30, ${skyBottom}, 200)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            const sunY = 100 - cameraY * 0.1;
            if (sunY > -100 && sunY < GAME_HEIGHT) {
                ctx.fillStyle = cameraY < -2000 ? '#CCCCCC' : '#FFD166';
                ctx.beginPath();
                ctx.arc(400, sunY, 40, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            drawCloud(100, 150 - cameraY * 0.05, 25);
            drawCloud(300, 80 - cameraY * 0.07, 30);
            drawCloud(150, 250 - cameraY * 0.03, 20);
            drawCloud(400, 200 - cameraY * 0.06, 28);
        }
        
        function drawCloud(x, y, size) {
            if (y > GAME_HEIGHT + 100 || y < -150) return;
            
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.arc(x + size * 0.9, y - size * 0.4, size * 0.8, 0, Math.PI * 2);
            ctx.arc(x + size * 1.7, y, size * 0.9, 0, Math.PI * 2);
            ctx.arc(x + size * 0.8, y + size * 0.4, size * 0.7, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawPlatform(platform) {
            const y = platform.y - cameraY;
            if (y > GAME_HEIGHT + 100 || y < -150) return;
            
            switch(platform.type) {
                case 'normal': ctx.fillStyle = '#7986CB'; break;
                case 'moving': ctx.fillStyle = '#4DB6AC'; break;
                case 'breakable': 
                    const healthRatio = platform.health / 3;
                    ctx.fillStyle = `rgb(${220 - healthRatio * 100}, ${80 + healthRatio * 100}, 80)`;
                    break;
                case 'spring': ctx.fillStyle = '#4DB6AC'; break;
                default: ctx.fillStyle = '#7986CB';
            }
            
            ctx.fillRect(platform.x, y, platform.width, platform.height);
            
            ctx.fillStyle = '#3F51B5';
            ctx.fillRect(platform.x, y + platform.height - 4, platform.width, 4);
            
            if (platform.type === 'spring') {
                ctx.fillStyle = '#FF7043';
                const springWidth = platform.width * 0.4;
                const springHeight = platform.height * 1.8;
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2, 
                    y - springHeight, 
                    springWidth, 
                    springHeight
                );
                
                ctx.fillStyle = '#BF360C';
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2 + 3, 
                    y - springHeight + 3, 
                    springWidth - 6, 
                    3
                );
                ctx.fillRect(
                    platform.x + platform.width/2 - springWidth/2 + 3, 
                    y - springHeight/2, 
                    springWidth - 6, 
                    3
                );
            }
        }
        
        function drawCoin(coin) {
            const y = coin.y - cameraY;
            if (y > GAME_HEIGHT + 100 || y < -150 || coin.collected) return;
            
            ctx.fillStyle = '#FFD166';
            ctx.beginPath();
            ctx.arc(coin.x + coin.width/2, y + coin.height/2, coin.width/2 - 2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#FFF9C4';
            ctx.beginPath();
            ctx.arc(coin.x + coin.width/2 - 4, y + coin.height/2 - 4, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawPlayer() {
            const y = player.y - cameraY;
            
            ctx.fillStyle = player.facingRight ? '#FF6B6B' : '#4ECDC4';
            ctx.fillRect(player.x, y, player.width, player.height * 0.8);
            
            ctx.fillStyle = '#FFD9B3';
            ctx.fillRect(player.x + 8, y - 16, player.width - 16, 24);
            
            ctx.fillStyle = '#000000';
            if (player.facingRight) {
                ctx.fillRect(player.x + 26, y - 10, 6, 8);
                ctx.fillRect(player.x + 36, y - 10, 6, 8);
            } else {
                ctx.fillRect(player.x + 10, y - 10, 6, 8);
                ctx.fillRect(player.x + 20, y - 10, 6, 8);
            }
            
            ctx.fillStyle = '#E74C3C';
            if (player.velY < -2) {
                ctx.beginPath();
                ctx.arc(player.x + 24, y + 2, 10, 0, Math.PI);
                ctx.fill();
            } else if (player.velY > 2) {
                ctx.beginPath();
                ctx.arc(player.x + 24, y + 8, 10, Math.PI, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillRect(player.x + 20, y + 4, 16, 3);
            }
            
            ctx.fillStyle = '#3498DB';
            ctx.fillRect(player.x + 10, y + player.height * 0.8 - 5, 10, 12);
            ctx.fillRect(player.x + 28, y + player.height * 0.8 - 5, 10, 12);
        }
        
        function drawParticles() {
            particles.forEach(p => {
                if (p.y - cameraY > GAME_HEIGHT + 100 || p.y - cameraY < -150) return;
                
                ctx.globalAlpha = p.life / 35;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y - cameraY, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });
        }
        
        function drawScore() {
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`ВЫСОТА: ${score}`, GAME_WIDTH / 2, 50);
            
            if (score < highScore) {
                ctx.fillStyle = '#FFD166';
                ctx.font = 'bold 22px Arial';
                ctx.fillText(`РЕКОРД: ${highScore}`, GAME_WIDTH / 2, 90);
            }
        }
        
        function draw() {
            // Очистка с учетом масштабирования
            ctx.setTransform(dpr * scaleX, 0, 0, dpr * scaleY, dpr * offsetX, dpr * offsetY);
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            
            drawBackground();
            platforms.forEach(drawPlatform);
            coins.forEach(drawCoin);
            drawParticles();
            drawPlayer();
            
            if (gameState === GAME_STATES.PLAYING) {
                drawScore();
            }
            
            // Сброс трансформации для UI (если нужно)
            ctx.setTransform(1, 0, 0, 1, 0, 0);
        }
        
        // ======================
        // ИГРОВОЙ ЦИКЛ И СОСТОЯНИЯ
        // ======================
        
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            menuScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            recordDisplay.classList.remove('hidden');
            gameState = GAME_STATES.PLAYING;
            
            score = 0;
            cameraY = 0;
            cameraTargetY = 0;
            player.x = GAME_WIDTH / 2;
            player.y = 650;
            player.velX = 0;
            player.velY = 0;
            player.facingRight = true;
            player.grounded = false;
            player.justJumped = false;
            
            generateInitialPlatforms();
        }
        
        function restartGame() {
            gameOverScreen.classList.add('hidden');
            gameState = GAME_STATES.PLAYING;
            
            score = 0;
            cameraY = 0;
            cameraTargetY = 0;
            player.x = GAME_WIDTH / 2;
            player.y = 650;
            player.velX = 0;
            player.velY = 0;
            player.facingRight = true;
            player.grounded = false;
            player.justJumped = false;
            
            generateInitialPlatforms();
        }
        
        function showMenu() {
            gameOverScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
            recordDisplay.classList.add('hidden');
            gameState = GAME_STATES.MENU;
        }
        
        function gameOver() {
            gameState = GAME_STATES.GAME_OVER;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('doodleJumpHighScore', highScore);
            }
            
            finalScoreDisplay.textContent = score;
            recordScoreDisplay.textContent = highScore;
            recordDisplay.textContent = `РЕКОРД: ${highScore}`;
            
            gameOverScreen.classList.remove('hidden');
        }
        
        // ======================
        // ЗАПУСК ИГРЫ
        // ======================
        
        window.addEventListener('load', () => {
            // Дополнительный вызов для гарантии правильного размера
            setTimeout(() => {
                setupCanvas();
                init();
            }, 100);
        });
	</script>
</body>

</html>