<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Party Wall ‚Äî Retro TV</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:black;color:white;font-family:"Arial","Helvetica",sans-serif;overflow:hidden}

/* background video */
video.bg{
  position:fixed;inset:0;width:100%;height:100%;
  object-fit:cover;z-index:0;filter:saturate(1.1) contrast(1.1) brightness(0.9);
}

/* crt overlay */
.crt{pointer-events:none;position:fixed;inset:0;z-index:2;
  background-image:linear-gradient(rgba(0,0,0,0.06)50%,rgba(0,0,0,0.03)50%);
  background-size:100% 4px;mix-blend-mode:overlay;
}
.vignette{position:fixed;inset:0;z-index:3;
  background:radial-gradient(ellipse at center,rgba(0,0,0,0)40%,rgba(0,0,0,0.45)100%);
  pointer-events:none;
}

/* main container */
.stage{
  position:fixed;inset:0;z-index:1;
  display:flex;align-items:center;justify-content:center;
  padding:64px 5% 96px 5%;
}

/* photo card */
.photo-card{
  position:relative;
  width:90vw;max-width:1400px;
  height:auto;
  max-height:calc(100vh - 64px - 96px);
  display:flex;align-items:center;justify-content:center;
  border-radius:24px;overflow:visible;
  background:transparent;
  box-shadow:0 20px 80px rgba(0,0,0,0.8);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: none;
}

.photo-card.preload{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  box-shadow:none !important;
  transition:none !important;
}

/* CRT & vignette */
.photo-crt, .photo-vignette{
  pointer-events:none;
  position:absolute;
  inset:0;
  border-radius:inherit;
  z-index:4;
}
.photo-crt{
  background-image:linear-gradient(rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.03) 50%);
  background-size:100% 4px;
  mix-blend-mode:overlay;
  opacity:0.9;
  z-index:4;
}
.photo-vignette{
  background:radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.45) 100%);
  z-index:5;
}

/* photo frame ‚Äî –£–ú–ï–ù–¨–®–ï–ù–û –∏ —Å –ø–∞—Ä–µ–Ω–∏–µ–º */
.photo-frame{
  position:relative;
  display:inline-flex;
  align-items:center;justify-content:center;
  padding:10px;
  background:rgba(0,0,0,0.35);
  border:8px solid rgba(255,0,80,0.95);
  border-radius:16px;
  box-shadow:0 8px 30px rgba(255,0,80,0.08);
  max-width:100%;
  max-height:100%;
  z-index:6;
  overflow:hidden;
  min-width:220px;
  min-height:140px;
  transform: scale(0.94);
  transform-origin: center;
  transition: width .28s ease, height .28s ease, box-shadow .28s ease;
}

/* === –Ø–í–ù–û–ï –ü–ê–†–ï–ù–ò–ï === */
.photo-frame.drifting {
  animation: drift 14s ease-in-out infinite alternate;
}

.photo-frame img{
  display:block;
  visibility:hidden;
  opacity:0;
  transition:opacity .22s ease;
  max-width:100%;
  max-height:calc(100vh - 64px - 96px - 40px);
  width:auto;
  height:auto;
  object-fit:contain;
  border-radius:8px;
  opacity: 0.98 !important;
}

.photo-card.preload .photo-frame,
.photo-card.preload .photo-crt,
.photo-card.preload .photo-vignette {
  opacity:0;
  visibility:hidden;
  transition: none !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è */
@keyframes slideInLeft {
  from { transform: translateX(-100vw) scale(0.94); opacity: 0; }
  to   { transform: translateX(0) scale(0.94); opacity: 1; }
}
@keyframes slideInRight {
  from { transform: translateX(100vw) scale(0.94); opacity: 0; }
  to   { transform: translateX(0) scale(0.94); opacity: 1; }
}
@keyframes slideOutLeft {
  from { transform: translateX(0) scale(0.94); opacity: 1; }
  to   { transform: translateX(-100vw) scale(0.94); opacity: 0; }
}
@keyframes slideOutRight {
  from { transform: translateX(0) scale(0.94); opacity: 1; }
  to   { transform: translateX(100vw) scale(0.94); opacity: 0; }
}

/* CRT –º–µ—Ä—Ü–∞–Ω–∏–µ */
@keyframes crt-flicker {
  0%, 100% { opacity: 0; filter: brightness(0) contrast(1); }
  10%      { opacity: 0.2; filter: brightness(0.3) contrast(1.2); }
  20%      { opacity: 0; }
  30%      { opacity: 0.4; filter: brightness(0.6) contrast(1.3); }
  40%      { opacity: 0.1; }
  50%      { opacity: 0.7; filter: brightness(0.9) contrast(1.4); }
  60%      { opacity: 0.3; }
  70%      { opacity: 0.9; filter: brightness(1.1) contrast(1.5); }
  80%      { opacity: 0.5; }
  90%      { opacity: 1; filter: brightness(1) contrast(1); }
}

/* === –£–°–ò–õ–ï–ù–ù–û–ï –ü–ê–†–ï–ù–ò–ï === */
@keyframes drift {
  0%   { transform: scale(0.9) translateX(-100px); }
  100% { transform: scale(0.9) translateX(100px); }
}

.photo-card.animating {
  animation-fill-mode: forwards;
  animation-timing-function: cubic-bezier(0.22, 0.61, 0.36, 1);
}

/* ticker */
.ticker{
  position:fixed;left:5%;right:5%;bottom:3%;
  z-index:6;height:72px;border-radius:8px;overflow:hidden;
  display:flex;align-items:center;
  background:linear-gradient(90deg,rgba(255,0,64,0.8),rgba(255,140,0,0.5));
  border:2px solid rgba(255,80,120,0.25);
  box-shadow:0 0 24px rgba(255,0,64,0.15);
  opacity: 1;
  visibility: visible;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}
.ticker.fade-out {
  opacity: 0;
  visibility: hidden;
}

.label{
  min-width:120px;text-align:center;font-weight:800;
  color:#fff;text-transform:uppercase;font-size:18px;
  border-right:2px solid rgba(255,255,255,0.1);padding-right:10px;margin-right:10px;
}
.marquee-wrap{
  flex:1;overflow:hidden;position:relative;
  /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –º–∞—Å–∫–∏ –ø–æ –∫—Ä–∞—è–º –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
  mask-image: linear-gradient(to right, transparent 0%, black 8%, black 92%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 8%, black 92%, transparent 100%);
}
.marquee{
  white-space:nowrap;display:inline-block;
  font-size:28px;font-weight:700;color:#ffdcdc;
  text-shadow:0 2px 8px rgba(0,0,0,0.8),0 0 18px rgba(255,34,85,0.5);
  padding: 0 40px; /* –û—Ç—Å—Ç—É–ø—ã –ø–æ –∫—Ä–∞—è–º –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è */
}
.marquee.initial {
  visibility: hidden;
}
.channel{
  position:fixed;left:5%;top:5%;z-index:6;
  color:#fff;font-weight:800;text-transform:uppercase;
  background:linear-gradient(90deg,#ff6b96,#ffb86b);
  padding:8px 12px;border-radius:6px;box-shadow:0 6px 20px rgba(0,0,0,0.5);
}

/* === QR –ö–û–î ‚Äî –ù–û–í–û–ï === */
.qr-container {
  position: fixed;
  right: 5%;
  top: 5%;
  z-index: 6;
  display: flex;
  align-items: center;
  gap: 12px;
}
.qr-code {
  width: 150px;
  height: 150px;
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  image-rendering: pixelated; /* –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏ QR */
}
.qr-code img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain;
}

/* DEBUG PANEL - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ */
/* .debug-panel {
  position: fixed;
  bottom: 1%;
  right: 1%;
  background: rgba(0,0,0,0.7);
  color: #0f0;
  padding: 8px 12px;
  border-radius: 8px;
  font-family: monospace;
  z-index: 1000;
  font-size: 14px;
  pointer-events: none;
} */
</style>
</head>
<body>
<video class="bg" autoplay loop muted playsinline>
  <source src="party-bg6.mp4" type="video/mp4">
</video>

<div class="stage">
  <div id="photoCard" class="photo-card hidden">
    <div class="photo-crt" aria-hidden="true"></div>
    <div class="photo-vignette" aria-hidden="true"></div>
    <div class="photo-frame">
      <img id="mainPhoto" src="" alt="">
    </div>
  </div>
</div>

<div class="crt"></div>
<div class="vignette"></div>

<div class="channel">MAIS TV</div>

<div class="qr-container">
  <div class="qr-code">
    <img id="qrCode" src="qr-code.png" alt="QR –∫–æ–¥ –¥–ª—è Telegram">
  </div>
</div>

<div class="ticker">
  <div class="label">SMS-–ß–∞—Ç</div>
  <div class="marquee-wrap" id="marqueeWrap">
    <div id="marquee" class="marquee">&nbsp;</div>
  </div>
</div>

<!-- DEBUG PANEL - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ -->
<!-- <div class="debug-panel" id="debugPanel">
  ‚ö° ANIMATION_SPEED: 1.0<br>
  üìù Marquee duration: 0s<br>
  üñºÔ∏è Photo show: 10s
</div> -->

<script type="module">
console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Party Wall TV');

// üîë –ö–õ–Æ–ß–ï–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø: –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢ –°–ö–û–†–û–°–¢–ò –í–°–ï–• –ê–ù–ò–ú–ê–¶–ò–ô
// 0.5 = –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, 1.0 = –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, 2.0 = –±—ã—Å—Ç—Ä–æ, 4.0 = –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
const ANIMATION_SPEED = 1.2; // –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

// 1. –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´
const SUPABASE_URL = 'https://luqsmllrhasibqellhqo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1cXNtbGxyaGFzaWJxZWxsaHFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjE2MDksImV4cCI6MjA3NzkzNzYwOX0.00e-UFmmjosbJhWq3sFNhDCQdYEzO0ZHVrW3k4Cid7U';

// 2. –†–ê–°–°–ß–ò–¢–ê–ù–ù–´–ï –í–†–ï–ú–ï–ù–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ (–ó–ê–í–ò–°–Ø–¢ –û–¢ ANIMATION_SPEED)
const TIMINGS = {
  // –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
  marqueeMinDuration: 15 / ANIMATION_SPEED,   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)
  marqueePixelsPerSec: 150 * ANIMATION_SPEED,  // –°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è (–ø–∏–∫—Å/—Å–µ–∫)
  
  // –ê–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ—Ç–æ
  crtFlickerDuration: 1.8 / ANIMATION_SPEED,  // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å CRT —ç—Ñ—Ñ–µ–∫—Ç–∞
  slideInDuration: 0.6 / ANIMATION_SPEED,     // –í—Ä–µ–º—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
  slideOutDuration: 0.5 / ANIMATION_SPEED,    // –í—Ä–µ–º—è –∏—Å—á–µ–∑–∞–Ω–∏—è —Ñ–æ—Ç–æ
  photoDisplayTime: 10000 / ANIMATION_SPEED,  // –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ç–æ (–º—Å)
  
  // –û–±—â–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏
  startMarqueeDelay: 150 / ANIMATION_SPEED,   // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
  nextMessageDelay: 30000 / ANIMATION_SPEED,  // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—á–µ—Ä–µ–¥–∏
  reconnectDelay: 3000 / ANIMATION_SPEED,     // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
};

// 3. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
const photoCard = document.getElementById('photoCard');
const mainPhoto = document.getElementById('mainPhoto');
const marquee = document.getElementById('marquee');
const marqueeWrap = document.getElementById('marqueeWrap');
const tickerEl = document.querySelector('.ticker');
const debugPanel = document.getElementById('debugPanel');

let queue = [];
let showing = false;
let messageCounter = 0;
let supabase = null;
let realtimeChannel = null;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;

// 4. –§–£–ù–ö–¶–ò–ò –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø
function esc(s){
  return s ? String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m])) : '';
}

// 5. –û–ë–ù–û–í–õ–ï–ù–ò–ï DEBUG –ü–ê–ù–ï–õ–ò
function updateDebugPanel() {
  if (debugPanel) {
    debugPanel.innerHTML = `
      ‚ö° ANIMATION_SPEED: ${ANIMATION_SPEED.toFixed(1)}<br>
      üìù Marquee speed: ${TIMINGS.marqueePixelsPerSec.toFixed(0)} px/s<br>
      üñºÔ∏è Photo show: ${(TIMINGS.photoDisplayTime/1000).toFixed(1)}s
    `;
  }
}
updateDebugPanel();

// 6. –ó–ê–ì–†–£–ó–ö–ê SUPABASE –° –†–ï–ó–ï–†–í–ù–´–ú–ò CDN
async function loadSupabase() {
  try {
    console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º Supabase –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ CDN...');
    const module = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm');
    console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ jsdelivr');
    return module;
  } catch (err1) {
    console.warn('‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', err1.message);
    
    try {
      console.log('üì¶ –ü—Ä–æ–±—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π CDN (esm.sh)...');
      const module = await import('https://esm.sh/@supabase/supabase-js@2.43.0');
      console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ esm.sh');
      return module;
    } catch (err2) {
      console.warn('‚ö†Ô∏è ESM CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', err2.message);
      
      try {
        console.log('üì¶ –ü—Ä–æ–±—É–µ–º —Ç—Ä–µ—Ç–∏–π CDN (skypack)...');
        const module = await import('https://cdn.skypack.dev/@supabase/supabase-js@2.43.0');
        console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ Skypack');
        return module;
      } catch (err3) {
        console.error('üî• –í—Å–µ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', err3);
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Supabase: –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
      }
    }
  }
}

// 7. –ù–ê–î–ï–ñ–ù–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö SUPABASE
async function initSupabase() {
  try {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      throw new Error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Supabase');
    }

    if (supabase) {
      console.log('üîå Supabase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      return supabase;
    }

    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Supabase...');
    const { createClient } = await loadSupabase();
    
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: {
        params: {
          eventsPerSecond: 10
        }
      }
    });
    
    console.log('‚úÖ –ö–ª–∏–µ–Ω—Ç Supabase —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
    return supabase;
  } catch (err) {
    console.error('üí• –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', err);
    throw err;
  }
}

// 8. –ù–ê–°–¢–†–û–ô–ö–ê REALTIME –ü–û–î–ü–ò–°–ö–ò –° –†–ï–ó–ï–†–í–ù–´–ú–ò –í–ê–†–ò–ê–ù–¢–ê–ú–ò
function setupRealtimeFallback(supabaseClient) {
  console.log('üì° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º realtime-–ø–æ–¥–ø–∏—Å–∫—É —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏...');
  
  // –í–ê–†–ò–ê–ù–¢ 1: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Supabase)
  try {
    console.log('üì° –ü–æ–ø—ã—Ç–∫–∞ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ supabase.channel()');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –º–µ—Ç–æ–¥ channel
    if (typeof supabaseClient.channel === 'function') {
      if (realtimeChannel) {
        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
        supabaseClient.removeChannel(realtimeChannel);
      }
      
      realtimeChannel = supabaseClient
        .channel('messages-channel')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'messages',
          filter: 'approved=eq.true'
        }, handleRealtimeMessage)
        .subscribe(handleSubscriptionStatus);
        
      console.log('‚úÖ Realtime-–ø–æ–¥–ø–∏—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥)');
      return true;
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ 1:', err.message);
  }
  
  // –í–ê–†–ò–ê–ù–¢ 2: –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  try {
    console.log('üì° –ü–æ–ø—ã—Ç–∫–∞ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ supabase.realtime.channel()');
    
    if (supabaseClient.realtime?.channel) {
      if (realtimeChannel) {
        supabaseClient.realtime.removeChannel(realtimeChannel);
      }
      
      realtimeChannel = supabaseClient.realtime
        .channel('messages-channel')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'messages'
        }, handleRealtimeMessage)
        .subscribe(handleSubscriptionStatus);
        
      console.log('‚úÖ Realtime-–ø–æ–¥–ø–∏—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥)');
      return true;
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ 2:', err.message);
  }
  
  // –í–ê–†–ò–ê–ù–¢ 3: –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥ (–µ—Å–ª–∏ realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
  console.log('‚ö†Ô∏è Realtime –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥...');
  setupPollingFallback();
  
  return false;
}

// 9. –û–ë–†–ê–ë–û–¢–ß–ò–ö REALTIME –°–û–û–ë–©–ï–ù–ò–ô
function handleRealtimeMessage(payload) {
  console.log('üîî Realtime —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', payload);
  
  const newRecord = payload.new || payload.record;
  if (!newRecord) {
    console.warn('‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–æ –ø—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
    return;
  }
  
  if (newRecord.approved) {
    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ approved —Å–æ–æ–±—â–µ–Ω–∏–µ:', newRecord.id, newRecord.text?.substring(0, 30) + '...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
    const exists = queue.some(msg => msg.id === newRecord.id);
    if (!exists) {
      queue.push(newRecord);
      tickerEl.classList.remove('fade-out');
      
      // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (!showing) {
        nextMessage();
      }
    } else {
      console.log('‚ÑπÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
    }
  } else {
    console.log('‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω–æ –Ω–µ–æ–¥–æ–±—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
  }
}

// 10. –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–¢–ê–¢–£–°–ê –ü–û–î–ü–ò–°–ö–ò
function handleSubscriptionStatus(status) {
  console.log(`üì∂ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: ${status}`);
  
  if (status === 'SUBSCRIBED') {
    reconnectAttempts = 0;
    console.log('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è realtime');
  } else if (status === 'TIMED_OUT') {
    console.warn('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...');
    setTimeout(() => reconnectRealtime(), TIMINGS.reconnectDelay);
  } else if (status === 'CHANNEL_ERROR') {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...');
    setTimeout(() => reconnectRealtime(), TIMINGS.reconnectDelay * 1.7);
  }
}

// 11. –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
function reconnectRealtime() {
  if (reconnectAttempts >= maxReconnectAttempts) {
    console.error('‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    setupPollingFallback();
    return;
  }
  
  reconnectAttempts++;
  console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${reconnectAttempts}...`);
  
  if (realtimeChannel) {
    try {
      supabase.removeChannel(realtimeChannel);
    } catch (err) {
      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞:', err.message);
    }
    realtimeChannel = null;
  }
  
  setupRealtimeFallback(supabase);
}

// 12. –†–ï–ó–ï–†–í–ù–´–ô –ü–û–õ–õ–ò–ù–ì (–µ—Å–ª–∏ realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
let pollingInterval = null;

function setupPollingFallback() {
  console.log('‚è±Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥ (–æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)');
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
  if (pollingInterval) clearInterval(pollingInterval);
  
  pollingInterval = setInterval(async () => {
    try {
      console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥...');
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('approved', true)
        .gt('timestamp', new Date(Date.now() - 60000).toISOString()) // –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
        .order('timestamp', { ascending: true });
      
      if (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª–ª–∏–Ω–≥–µ:', error);
        return;
      }
      
      if (data?.length) {
        console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥`);
        
        data.forEach(newMsg => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
          const exists = queue.some(msg => msg.id === newMsg.id);
          if (!exists) {
            queue.push(newMsg);
            console.log('‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥:', newMsg.id);
          }
        });
        
        if (!showing && queue.length > 0) {
          nextMessage();
        }
      }
    } catch (err) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ª–ª–∏–Ω–≥–µ:', err);
    }
  }, 10000);
}

// 13. –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –°–û–û–ë–©–ï–ù–ò–ô
async function loadMessageHistory() {
  try {
    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...');
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .eq('approved', true)
      .order('timestamp', { ascending: false }) // –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏
      .limit(20);
    
    if (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      return [];
    }
    
    if (!data || data.length === 0) {
      console.log('üì≠ –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞');
      tickerEl.classList.add('fade-out');
      return [];
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏`);
    return data;
  } catch (err) {
    console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏:', err);
    return [];
  }
}

// 14. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø REALTIME
async function initializeRealtime() {
  try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞
    await initSupabase();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    const history = await loadMessageHistory();
    queue = [...history];
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º realtime
    console.log('üîå –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º realtime-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
    const realtimeSuccess = setupRealtimeFallback(supabase);
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ
    if (queue.length > 0) {
      console.log('‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏');
      nextMessage();
    } else if (!realtimeSuccess) {
      // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏ realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      tickerEl.classList.add('fade-out');
    }
    
  } catch (err) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
    
    // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç - –ø–æ–ª–ª–∏–Ω–≥
    if (!pollingInterval) {
      console.log('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥');
      await initSupabase(); // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      setupPollingFallback();
    }
    
    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
    setTimeout(initializeRealtime, 30000);
  }
}

// 15. –°–ò–ù–•–†–û–ù–ù–ê–Ø –ë–ï–ì–£–©–ê–Ø –°–¢–†–û–ö–ê (–° –£–ß–ï–¢–û–ú ANIMATION_SPEED)
function startMarquee(item) {
  console.log('üóûÔ∏è –ó–∞–ø—É—Å–∫ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é)');
  
  const rawText = (item.text || '').trim();
  if (rawText.length < 4) {
    console.warn('‚úâÔ∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–µ:', rawText);
    return;
  }

  // –§–û–†–ú–ò–†–£–ï–ú –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† –¢–ï–ö–°–¢–ê
  const text = `${esc(item.author || '–ê–Ω–æ–Ω–∏–º')}: ${esc(rawText)}`;
  marquee.innerHTML = text;
  
  // –°–ë–†–ê–°–´–í–ê–ï–ú –ü–†–ï–î–´–î–£–©–£–Æ –ê–ù–ò–ú–ê–¶–ò–Æ
  marquee.style.animation = 'none';
  marquee.style.transform = '';
  marquee.classList.remove('initial');

  requestAnimationFrame(() => {
    const cw = marquee.scrollWidth;
    const vw = marqueeWrap.clientWidth;
    
    // –†–ê–°–°–ß–ò–¢–ê–ù–ù–ê–Ø –°–ö–û–†–û–°–¢–¨ –° –£–ß–ï–¢–û–ú –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–ê
    const spd = TIMINGS.marqueePixelsPerSec;
    const dur = Math.max(TIMINGS.marqueeMinDuration, (cw + vw * 2) / spd);
    
    const st = document.getElementById('marqStyle') || (() => {
      let s = document.createElement('style');
      s.id = 'marqStyle';
      document.head.appendChild(s);
      return s;
    })();

    // –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø –î–õ–Ø –û–î–ù–û–ì–û –¢–ï–ö–°–¢–ê –° –ü–õ–ê–í–ù–´–ú –í–û–ó–í–†–ê–¢–û–ú
    st.textContent = `
      @keyframes move {
        0%    { transform: translateX(${vw}px); }
        92%   { transform: translateX(-${cw}px); }
        100%  { transform: translateX(${vw}px); }
      }
    `;
    
    // –ü–õ–ê–í–ù–´–ô –°–¢–ê–†–¢ –ò –û–°–¢–ê–ù–û–í–ö–ê
    marquee.style.animation = `move ${dur}s ease-in-out infinite`;
    
    // DEBUG: –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å
    if (debugPanel) {
      debugPanel.children[1].textContent = `üìù Marquee duration: ${dur.toFixed(1)}s`;
    }
  });
}

// 16. –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø (–° –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ï–ô)
function showMessage(item, textOnly = false) {
  const rawText = (item.text || '').trim();
  if (rawText.length < 4) {
    console.warn('‚úâÔ∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', rawText);
    return;
  }

  const text = `${esc(item.author || '–ê–Ω–æ–Ω–∏–º')}: ${esc(rawText)}`;
  
  // –ì–û–¢–û–í–ò–ú –ë–ï–ì–£–©–£–Æ –°–¢–†–û–ö–£ –î–õ–Ø –¢–ï–ö–£–©–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø
  marquee.classList.add('initial');
  marquee.innerHTML = text;
  tickerEl.classList.remove('fade-out');

  if (textOnly) {
    console.log('üí¨ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);
    startMarquee(item);
    
    setTimeout(() => {
      marquee.innerHTML = '&nbsp;';
      marquee.style.animation = 'none';
      showing = false;
      nextMessage();
    }, TIMINGS.photoDisplayTime / 1.5); // –¢–µ–∫—Å—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ —Ñ–æ—Ç–æ
    
    showing = true;
    return;
  }

  photoCard.classList.remove('hidden');
  photoCard.classList.add('preload');

  const frame = document.querySelector('.photo-frame');
  frame.style.width = '';
  frame.style.height = '';
  frame.classList.remove('drifting');

  mainPhoto.style.visibility = 'hidden';
  mainPhoto.style.opacity = '0';
  mainPhoto.src = item.image_url;

  const onLoaded = () => {
    console.log('üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', item.image_url);
    
    const style = getComputedStyle(frame);
    const paddingX = parseFloat(style.paddingLeft || 0) + parseFloat(style.paddingRight || 0);
    const paddingY = parseFloat(style.paddingTop || 0) + parseFloat(style.paddingBottom || 0);
    const borderX = parseFloat(style.borderLeftWidth || 0) + parseFloat(style.borderRightWidth || 0);
    const borderY = parseFloat(style.borderTopWidth || 0) + parseFloat(style.borderBottomWidth || 0);

    const availableW = Math.max(40, photoCard.clientWidth - (paddingX + borderX));
    const availableH = Math.max(40, photoCard.clientHeight - (paddingY + borderY));

    const natW = mainPhoto.naturalWidth || availableW;
    const natH = mainPhoto.naturalHeight || availableH;
    const ratio = natW / natH || 1;

    let imgW = availableW;
    let imgH = Math.round(imgW / ratio);
    if (imgH > availableH) {
      imgH = availableH;
      imgW = Math.round(imgH * ratio);
    }

    const frameW = imgW + paddingX + borderX;
    const frameH = imgH + paddingY + borderY;

    frame.style.width = Math.max(frameW, parseFloat(getComputedStyle(frame).minWidth) || 0) + 'px';
    frame.style.height = Math.max(frameH, parseFloat(getComputedStyle(frame).minHeight) || 0) + 'px';

    photoCard.classList.remove('preload');

    // CRT —ç—Ñ—Ñ–µ–∫—Ç —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
    frame.style.animation = `crt-flicker ${TIMINGS.crtFlickerDuration}s steps(1) forwards`;
    mainPhoto.style.visibility = 'visible';

    setTimeout(() => {
      mainPhoto.style.opacity = '0.9';
      frame.style.animation = '';
      frame.classList.add('drifting');

      messageCounter++;
      const isEven = messageCounter % 2 === 0;
      const inAnim = isEven ? 'slideInRight' : 'slideInLeft';
      const outAnim = isEven ? 'slideOutLeft' : 'slideOutRight';

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
      photoCard.style.animation = `${inAnim} ${TIMINGS.slideInDuration}s cubic-bezier(0.22, 0.61, 0.36, 1) forwards`;
      photoCard.classList.add('animating');

      setTimeout(() => {
        startMarquee(item);
      }, TIMINGS.startMarqueeDelay);

      // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–∞–Ω–∏—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
      setTimeout(() => {
        photoCard.style.animation = `${outAnim} ${TIMINGS.slideOutDuration}s cubic-bezier(0.55, 0.09, 0.68, 0.53) forwards`;
        setTimeout(() => {
          photoCard.classList.remove('animating');
          photoCard.classList.add('hidden');
          mainPhoto.src = '';
          showing = false;
          nextMessage();
        }, TIMINGS.slideOutDuration * 1000);
      }, TIMINGS.photoDisplayTime);
    }, TIMINGS.crtFlickerDuration * 1000);

    cleanup();
  };

  const onError = (e) => {
    console.error('üî• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
    cleanup();
    showMessage(item, true);
  };

  const cleanup = () => {
    mainPhoto.removeEventListener('load', onLoaded);
    mainPhoto.removeEventListener('error', onError);
  };

  mainPhoto.addEventListener('load', onLoaded);
  mainPhoto.addEventListener('error', onError);

  if (mainPhoto.complete && mainPhoto.naturalWidth) {
    setTimeout(onLoaded, 0);
  }

  showing = true;
}

function nextMessage() {
  console.log(`‚è≠Ô∏è –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—á–µ—Ä–µ–¥—å: ${queue.length}, –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: ${showing}`);
  
  if (showing || queue.length === 0) {
    tickerEl.classList.add('fade-out');
    return;
  }

  let item;
  let rawText;

  while (queue.length > 0) {
    item = queue.shift();
    if (!item) continue;
    
    rawText = (item.text || '').trim();
    if (rawText.length >= 4) {
      break;
    }
    item = null;
  }

  if (!item || rawText.length < 4) {
    console.log('‚èπÔ∏è –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞');
    showing = false;
    tickerEl.classList.add('fade-out');
    return;
  }

  console.log('‚û°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', item.id || '–±–µ–∑ ID');
  showing = true;
  const hasImage = !!(item.image_url && item.image_url.trim());
  
  if (hasImage) {
    showMessage(item, false);
  } else {
    showMessage(item, true);
  }
}

// 17. –ì–õ–ê–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
document.addEventListener('DOMContentLoaded', async () => {
  console.log('‚úÖ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω, —Å—Ç–∞—Ä—Ç—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
  
  try {
    await initializeRealtime();
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
    setInterval(() => {
      if (!showing && queue.length > 0) {
        console.log('‚ôªÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –æ—á–µ—Ä–µ–¥–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è)');
        nextMessage();
      }
    }, TIMINGS.nextMessageDelay);
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    setInterval(() => {
      if (supabase && realtimeChannel) {
        const state = realtimeChannel.state;
        if (state !== 'SUBSCRIBED') {
          console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${state}, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è`);
          reconnectRealtime();
        }
      }
    }, 60000);
    
  } catch (err) {
    console.error('üî• –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:', err);
    
    // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    setTimeout(() => {
      console.log('üîÑ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞...');
      location.reload();
    }, 60000);
  }
});

// 18. –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–¢–ï–†–ò –°–û–ï–î–ò–ù–ï–ù–ò–Ø
window.addEventListener('online', () => {
  console.log('üåê –°–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  if (supabase) {
    reconnectRealtime();
  } else {
    initializeRealtime();
  }
});

window.addEventListener('offline', () => {
  console.warn('‚ö†Ô∏è –°–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
});
</script>
</body>
</html>
