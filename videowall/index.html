<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Party Wall ‚Äî Retro TV</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:black;color:white;font-family:"Arial","Helvetica",sans-serif;overflow:hidden}

/* background video */
video.bg{
  position:fixed;inset:0;width:100%;height:100%;
  object-fit:cover;z-index:0;filter:saturate(1.1) contrast(1.1) brightness(0.9);
}

/* crt overlay */
.crt{pointer-events:none;position:fixed;inset:0;z-index:2;
  background-image:linear-gradient(rgba(0,0,0,0.06)50%,rgba(0,0,0,0.03)50%);
  background-size:100% 4px;mix-blend-mode:overlay;
}
.vignette{position:fixed;inset:0;z-index:3;
  background:radial-gradient(ellipse at center,rgba(0,0,0,0)40%,rgba(0,0,0,0.45)100%);
  pointer-events:none;
}

/* main container */
.stage{
  position:fixed;inset:0;z-index:1;
  display:flex;align-items:center;justify-content:center;
  padding:64px 5% 96px 5%;
}

/* photo card */
.photo-card{
  position:relative;
  width:90vw;max-width:1400px;
  height:auto;
  max-height:calc(100vh - 64px - 96px);
  display:flex;align-items:center;justify-content:center;
  border-radius:24px;overflow:visible;
  background:transparent;
  box-shadow:0 20px 80px rgba(0,0,0,0.8);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: none;
}

.photo-card.preload{
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  box-shadow:none !important;
  transition:none !important;
}

/* CRT & vignette */
.photo-crt, .photo-vignette{
  pointer-events:none;
  position:absolute;
  inset:0;
  border-radius:inherit;
  z-index:4;
}
.photo-crt{
  background-image:linear-gradient(rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.03) 50%);
  background-size:100% 4px;
  mix-blend-mode:overlay;
  opacity:0.9;
  z-index:4;
}
.photo-vignette{
  background:radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,0.45) 100%);
  z-index:5;
}

/* photo frame ‚Äî –£–ú–ï–ù–¨–®–ï–ù–û –∏ —Å –ø–∞—Ä–µ–Ω–∏–µ–º */
.photo-frame{
  position:relative;
  display:inline-flex;
  align-items:center;justify-content:center;
  padding:10px;
  background:rgba(0,0,0,0.35);
  border:8px solid rgba(255,0,80,0.95);
  border-radius:16px;
  box-shadow:0 8px 30px rgba(255,0,80,0.08);
  max-width:100%;
  max-height:100%;
  z-index:6;
  overflow:hidden;
  min-width:220px;
  min-height:140px;
  transform: scale(0.94);
  transform-origin: center;
  transition: width .28s ease, height .28s ease, box-shadow .28s ease;
}

/* === –Ø–í–ù–û–ï –ü–ê–†–ï–ù–ò–ï === */
.photo-frame.drifting {
  animation: drift 14s ease-in-out infinite alternate;
}

.photo-frame img{
  display:block;
  visibility:hidden;
  opacity:0;
  transition:opacity .22s ease;
  max-width:100%;
  max-height:calc(100vh - 64px - 96px - 40px);
  width:auto;
  height:auto;
  object-fit:contain;
  border-radius:8px;
  opacity: 0.98 !important;
}

.photo-card.preload .photo-frame,
.photo-card.preload .photo-crt,
.photo-card.preload .photo-vignette {
  opacity:0;
  visibility:hidden;
  transition: none !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è */
@keyframes slideInLeft {
  from { transform: translateX(-100vw) scale(0.94); opacity: 0; }
  to   { transform: translateX(0) scale(0.94); opacity: 1; }
}
@keyframes slideInRight {
  from { transform: translateX(100vw) scale(0.94); opacity: 0; }
  to   { transform: translateX(0) scale(0.94); opacity: 1; }
}
@keyframes slideOutLeft {
  from { transform: translateX(0) scale(0.94); opacity: 1; }
  to   { transform: translateX(-100vw) scale(0.94); opacity: 0; }
}
@keyframes slideOutRight {
  from { transform: translateX(0) scale(0.94); opacity: 1; }
  to   { transform: translateX(100vw) scale(0.94); opacity: 0; }
}

/* CRT –º–µ—Ä—Ü–∞–Ω–∏–µ */
@keyframes crt-flicker {
  0%, 100% { opacity: 0; filter: brightness(0) contrast(1); }
  10%      { opacity: 0.2; filter: brightness(0.3) contrast(1.2); }
  20%      { opacity: 0; }
  30%      { opacity: 0.4; filter: brightness(0.6) contrast(1.3); }
  40%      { opacity: 0.1; }
  50%      { opacity: 0.7; filter: brightness(0.9) contrast(1.4); }
  60%      { opacity: 0.3; }
  70%      { opacity: 0.9; filter: brightness(1.1) contrast(1.5); }
  80%      { opacity: 0.5; }
  90%      { opacity: 1; filter: brightness(1) contrast(1); }
}

/* === –£–°–ò–õ–ï–ù–ù–û–ï –ü–ê–†–ï–ù–ò–ï === */
@keyframes drift {
  0%   { transform: scale(0.9) translateX(-100px); }
  100% { transform: scale(0.9) translateX(100px); }
}

.photo-card.animating {
  animation-fill-mode: forwards;
  animation-timing-function: cubic-bezier(0.22, 0.61, 0.36, 1);
}

/* ticker */
.ticker{
  position:fixed;left:5%;right:5%;bottom:3%;
  z-index:6;height:72px;border-radius:8px;overflow:hidden;
  display:flex;align-items:center;
  background:linear-gradient(90deg,rgba(255,0,64,0.8),rgba(255,140,0,0.5));
  border:2px solid rgba(255,80,120,0.25);
  box-shadow:0 0 24px rgba(255,0,64,0.15);
  opacity: 1;
  visibility: visible;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}
.ticker.fade-out {
  opacity: 0;
  visibility: hidden;
}

.label{
  min-width:120px;text-align:center;font-weight:800;
  color:#fff;text-transform:uppercase;font-size:18px;
  border-right:2px solid rgba(255,255,255,0.1);padding-right:10px;margin-right:10px;
}
.marquee-wrap{
  flex:1;overflow:hidden;position:relative;
  /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –º–∞—Å–∫–∏ –ø–æ –∫—Ä–∞—è–º –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
  mask-image: linear-gradient(to right, transparent 0%, black 8%, black 92%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 8%, black 92%, transparent 100%);
}
.marquee{
  white-space:nowrap;display:inline-block;
  font-size:28px;font-weight:700;color:#ffdcdc;
  text-shadow:0 2px 8px rgba(0,0,0,0.8),0 0 18px rgba(255,34,85,0.5);
  padding: 0 40px; /* –û—Ç—Å—Ç—É–ø—ã –ø–æ –∫—Ä–∞—è–º –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è */
}
.marquee.initial {
  visibility: hidden;
}
.channel{
  position:fixed;left:5%;top:5%;z-index:6;
  color:#fff;font-weight:800;text-transform:uppercase;
  background:linear-gradient(90deg,#ff6b96,#ffb86b);
  padding:8px 12px;border-radius:6px;box-shadow:0 6px 20px rgba(0,0,0,0.5);
  cursor: pointer;
  transition: all 0.3s ease;
}
.channel:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 30px rgba(255, 107, 150, 0.7);
}

/* === QR –ö–û–î ‚Äî –ù–û–í–û–ï === */
.qr-container {
  position: fixed;
  right: 5%;
  top: 5%;
  z-index: 6;
  display: flex;
  align-items: center;
  gap: 12px;
}
.qr-code {
  width: 150px;
  height: 150px;
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  image-rendering: pixelated; /* –¥–ª—è —á—ë—Ç–∫–æ—Å—Ç–∏ QR */
}
.qr-code img {
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain;
}

/* Status indicators */
.status-indicator {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.8);
  color: #ff6b96;
  padding: 20px 40px;
  border-radius: 12px;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  z-index: 100;
  border: 2px solid #ff6b96;
  box-shadow: 0 0 30px rgba(255, 107, 150, 0.5);
  display: none;
}
.status-indicator.error {
  color: #ff4d4d;
  border-color: #ff4d4d;
  box-shadow: 0 0 30px rgba(255, 77, 77, 0.5);
}
.status-indicator.warning {
  color: #ffb86b;
  border-color: #ffb86b;
  box-shadow: 0 0 30px rgba(255, 184, 107, 0.5);
}

/* Connection status badge */
.connection-status {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: #ff4d4d;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  z-index: 1000;
  border: 1px solid #ff4d4d;
  cursor: pointer;
}
.connection-status.online {
  color: #4dff4d;
  border-color: #4dff4d;
}
.connection-status.realtime {
  color: #4dffff;
  border-color: #4dffff;
}

/* Settings Modal */
.settings-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.92);
  z-index: 1000;
  display: none;
  flex-direction: column;
  padding: 20px;
  overflow: hidden;
}
.settings-modal.active {
  display: flex;
}
.settings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255, 107, 150, 0.5);
  margin-bottom: 20px;
}
.settings-title {
  font-size: 28px;
  font-weight: bold;
  background: linear-gradient(90deg, #ff6b96, #ffb86b);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.close-settings {
  background: rgba(255, 107, 150, 0.2);
  border: 1px solid #ff6b96;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.close-settings:hover {
  background: rgba(255, 107, 150, 0.4);
  transform: rotate(90deg);
}
.settings-content {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  max-height: calc(100vh - 100px);
  overflow-y: auto;
}
.settings-section {
  flex: 1;
  min-width: 300px;
  background: rgba(20, 20, 30, 0.7);
  border-radius: 12px;
  padding: 20px;
  border: 1px solid rgba(255, 107, 150, 0.3);
}
.section-title {
  font-size: 20px;
  margin-bottom: 15px;
  color: #ff6b96;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-title i {
  font-size: 24px;
}
.control-group {
  margin-bottom: 15px;
}
.control-label {
  display: block;
  margin-bottom: 8px;
  color: #ccc;
}
.control-input {
  width: 100%;
  padding: 10px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 107, 150, 0.5);
  color: white;
  border-radius: 6px;
  font-size: 16px;
}
.control-input:focus {
  outline: none;
  border-color: #ff6b96;
  box-shadow: 0 0 10px rgba(255, 107, 150, 0.3);
}
.radio-group {
  display: flex;
  gap: 15px;
  margin-top: 10px;
}
.radio-option {
  display: flex;
  align-items: center;
  gap: 5px;
}
.radio-option input {
  cursor: pointer;
}
.radio-option label {
  cursor: pointer;
  color: #ccc;
}
.radio-option input:checked + label {
  color: #ff6b96;
  font-weight: bold;
}
.queue-item {
  background: rgba(30, 30, 40, 0.7);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
  border-left: 3px solid #ff6b96;
  position: relative;
}
.queue-item:hover {
  background: rgba(40, 40, 50, 0.8);
}
.queue-author {
  font-weight: bold;
  color: #ff6b96;
  margin-bottom: 3px;
}
.queue-text {
  color: #ddd;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.queue-controls {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 8px;
}
.queue-btn {
  background: rgba(255, 107, 150, 0.2);
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 4px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  opacity: 0.7;
  transition: all 0.2s ease;
}
.queue-btn:hover {
  opacity: 1;
  background: rgba(255, 107, 150, 0.4);
}
.action-button {
  background: linear-gradient(90deg, rgba(255,107,150,0.8), rgba(255,184,107,0.8));
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
  margin-top: 10px;
}
.action-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(255, 107, 150, 0.5);
}
.action-button.skip {
  background: linear-gradient(90deg, rgba(255,77,77,0.8), rgba(255,150,107,0.8));
}
.action-button.reload {
  background: linear-gradient(90deg, rgba(77,193,255,0.8), rgba(107,150,255,0.8));
}
.current-item {
  background: rgba(77, 193, 255, 0.15) !important;
  border-left-color: #4dc1ff !important;
}
</style>
</head>
<body>
<video class="bg" autoplay loop muted playsinline>
  <source src="party-bg6.mp4" type="video/mp4">
</video>

<div class="stage">
  <div id="photoCard" class="photo-card hidden">
    <div class="photo-crt" aria-hidden="true"></div>
    <div class="photo-vignette" aria-hidden="true"></div>
    <div class="photo-frame">
      <img id="mainPhoto" src="" alt="">
    </div>
  </div>
</div>

<div class="crt"></div>
<div class="vignette"></div>

<div class="channel" id="channelLogo">MAIS TV</div>

<div class="qr-container">
  <div class="qr-code">
    <img id="qrCode" src="qr-code.png" alt="QR –∫–æ–¥ –¥–ª—è Telegram">
  </div>
</div>

<div class="ticker">
  <div class="label">SMS-–ß–∞—Ç</div>
  <div class="marquee-wrap" id="marqueeWrap">
    <div id="marquee" class="marquee">&nbsp;</div>
  </div>
</div>

<div id="statusIndicator" class="status-indicator">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</div>
<div id="connectionStatus" class="connection-status">Offline</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settingsModal">
  <div class="settings-header">
    <div class="settings-title">üì∫ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MAIS TV</div>
    <button class="close-settings" id="closeSettings">‚úï</button>
  </div>
  <div class="settings-content">
    <div class="settings-section">
      <div class="section-title">‚öôÔ∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
      <div class="control-group">
        <div class="control-label">–¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</div>
        <div class="radio-group">
          <div class="radio-option">
            <input type="radio" id="mode-realtime" name="connection-mode" value="realtime" checked>
            <label for="mode-realtime">Realtime (–∞–≤—Ç–æ)</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="mode-polling" name="connection-mode" value="polling">
            <label for="mode-polling">–¢–æ–ª—å–∫–æ –ø–æ–ª–ª–∏–Ω–≥</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="mode-test" name="connection-mode" value="test">
            <label for="mode-test">–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
          </div>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–ª–ª–∏–Ω–≥–∞ (—Å–µ–∫):</div>
        <input type="number" class="control-input" id="pollingInterval" value="30" min="5" max="300">
      </div>
      <button class="action-button reload" id="reloadData">üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    
    <div class="settings-section">
      <div class="section-title">üìã –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π</div>
      <div id="queueList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
        <!-- –û—á–µ—Ä–µ–¥—å –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
      </div>
      <button class="action-button skip" id="skipCurrent">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
    </div>
    
    <div class="settings-section">
      <div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="control-group">
        <div class="control-label">–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏:</div>
        <div id="queueCount" style="font-size: 24px; font-weight: bold; color: #ff6b96;">0</div>
      </div>
      <div class="control-group">
        <div class="control-label">–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º:</div>
        <div id="currentMode" style="font-size: 18px; color: #4dc1ff;">Realtime (–∞–≤—Ç–æ)</div>
      </div>
      <div class="control-group">
        <div class="control-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</div>
        <div id="connectionState" style="font-size: 18px; color: #ff4d4d;">Offline</div>
      </div>
      <div class="control-group">
        <div class="control-label">–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:</div>
        <div id="lastUpdate" style="font-size: 16px; color: #ccc;">-</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Party Wall TV');

// üîë –ö–õ–Æ–ß–ï–í–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø: –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢ –°–ö–û–†–û–°–¢–ò –í–°–ï–• –ê–ù–ò–ú–ê–¶–ò–ô
const ANIMATION_SPEED = 1.2;

// 1. –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ - –£–î–ê–õ–ò–õ–ò –õ–ò–®–ù–ò–ï –ü–†–û–ë–ï–õ–´
const SUPABASE_URL = 'https://luqsmllrhasibqellhqo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1cXNtbGxyaGFzaWJxZWxsaHFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjE2MDksImV4cCI6MjA3NzkzNzYwOX0.00e-UFmmjosbJhWq3sFNhDCQdYEzO0ZHVrW3k4Cid7U';

// 2. –†–ê–°–°–ß–ò–¢–ê–ù–ù–´–ï –í–†–ï–ú–ï–ù–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´
const TIMINGS = {
  // –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
  marqueeMinDuration: 15 / ANIMATION_SPEED,
  marqueePixelsPerSec: 150 * ANIMATION_SPEED,
  
  // –ê–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ—Ç–æ
  crtFlickerDuration: 1.8 / ANIMATION_SPEED,
  slideInDuration: 0.6 / ANIMATION_SPEED,
  slideOutDuration: 0.5 / ANIMATION_SPEED,
  photoDisplayTime: 10000 / ANIMATION_SPEED,
  
  // –û–±—â–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏
  startMarqueeDelay: 150 / ANIMATION_SPEED,
  nextMessageDelay: 30000 / ANIMATION_SPEED,
  reconnectDelay: 3000 / ANIMATION_SPEED,
  defaultPollingInterval: 30000, // 30 —Å–µ–∫—É–Ω–¥
};

// 3. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
const photoCard = document.getElementById('photoCard');
const mainPhoto = document.getElementById('mainPhoto');
const marquee = document.getElementById('marquee');
const marqueeWrap = document.getElementById('marqueeWrap');
const tickerEl = document.querySelector('.ticker');
const statusIndicator = document.getElementById('statusIndicator');
const connectionStatus = document.getElementById('connectionStatus');
const channelLogo = document.getElementById('channelLogo');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const queueList = document.getElementById('queueList');
const queueCount = document.getElementById('queueCount');
const currentMode = document.getElementById('currentMode');
const connectionState = document.getElementById('connectionState');
const lastUpdate = document.getElementById('lastUpdate');
const skipCurrentBtn = document.getElementById('skipCurrent');
const reloadDataBtn = document.getElementById('reloadData');

// DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
const modeRealtime = document.getElementById('mode-realtime');
const modePolling = document.getElementById('mode-polling');
const modeTest = document.getElementById('mode-test');
const pollingIntervalInput = document.getElementById('pollingInterval');

let queue = [];
let showing = false;
let messageCounter = 0;
let supabase = null;
let realtimeChannel = null;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;
let isOnline = navigator.onLine;
let lastConnectionCheck = Date.now();
let pollingInterval = null;
let currentMessage = null;
let manualMode = false;
let lastDataUpdate = new Date().toISOString();

// 4. –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï –ù–ê –°–õ–£–ß–ê–ô –û–¢–°–£–¢–°–¢–í–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
const TEST_MESSAGES = [
  {
    id: 'test1',
    text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ Party Wall TV! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞.',
    author: '–°–∏—Å—Ç–µ–º–∞',
    image_url: '',
    timestamp: new Date().toISOString(),
    approved: true
  },
  {
    id: 'test2',
    text: '–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–Ω–∞—á–∏—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏ –∏ Supabase.',
    author: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
    image_url: '',
    timestamp: new Date().toISOString(),
    approved: true
  },
  {
    id: 'test3',
    text: '–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –∏ API-–∫–ª—é—á Supabase –≤ –∫–æ–¥–µ.',
    author: '–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞',
    image_url: '',
    timestamp: new Date().toISOString(),
    approved: true
  },
  {
    id: 'test4',
    text: '–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –Ω–∞–∂–∞–≤ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø MAIS TV –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —ç–∫—Ä–∞–Ω–∞.',
    author: '–ü–æ–º–æ—â—å',
    image_url: '',
    timestamp: new Date().toISOString(),
    approved: true
  }
];

// 5. –§–£–ù–ö–¶–ò–ò –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø
function esc(s){
  return s ? String(s).replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m])) : '';
}

// 6. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
function showStatus(message, type = 'warning', duration = 5000) {
  statusIndicator.textContent = message;
  statusIndicator.className = 'status-indicator';
  statusIndicator.classList.add(type);
  statusIndicator.style.display = 'block';
  
  if (duration > 0) {
    setTimeout(() => {
      statusIndicator.style.display = 'none';
    }, duration);
  }
  
  console.log(`[${type.toUpperCase()}] ${message}`);
}

// 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
function updateConnectionStatus() {
  const now = Date.now();
  if (now - lastConnectionCheck < 1000) return;
  
  lastConnectionCheck = now;
  isOnline = navigator.onLine;
  
  connectionStatus.textContent = isOnline ? 'Online' : 'Offline';
  connectionStatus.className = isOnline ? 'connection-status online' : 'connection-status';
  
  if (!isOnline) {
    showStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!', 'error', 3000);
  }
  
  updateSettingsUI();
  return isOnline;
}

// 8. –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò SUPABASE
async function checkSupabaseConnection() {
  try {
    if (!isOnline) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ URL Supabase
    const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      method: 'GET',
      mode: 'cors'
    });
    
    return response.ok;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:', error);
    return false;
  }
}

// 9. –ó–ê–ì–†–£–ó–ö–ê SUPABASE –° –õ–û–ö–ê–õ–¨–ù–´–ú –†–ï–ó–ï–†–í–ù–´–ú –í–ê–†–ò–ê–ù–¢–û–ú
async function loadSupabase() {
  try {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ CDN
    console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º Supabase –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ CDN...');
    
    try {
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/+esm');
      console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ jsdelivr');
      return { createClient };
    } catch (err1) {
      console.warn('‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', err1.message);
    }
    
    try {
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2.43.0');
      console.log('‚úÖ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ esm.sh');
      return { createClient };
    } catch (err2) {
      console.warn('‚ö†Ô∏è ESM CDN –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', err2.message);
    }
    
    // –ï—Å–ª–∏ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞–ø—Ä—è–º—É—é)
    if (window.supabase) {
      console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Supabase');
      return { createClient: () => window.supabase };
    }
    
    throw new Error('–í—Å–µ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
  } catch (error) {
    console.error('üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Supabase:', error);
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Supabase!', 'error', 8000);
    return null;
  }
}

// 10. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø SUPABASE –° –ü–†–û–í–ï–†–ö–ê–ú–ò
async function initSupabase() {
  if (supabase) {
    console.log('üîå Supabase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    return supabase;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
  if (!updateConnectionStatus()) {
    console.warn('‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Supabase');
    return null;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Supabase
  const supabaseAvailable = await checkSupabaseConnection();
  if (!supabaseAvailable) {
    console.warn('‚ö†Ô∏è Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
    showStatus('Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'warning', 5000);
    return null;
  }

  console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Supabase...');
  
  const supabaseModule = await loadSupabase();
  if (!supabaseModule) {
    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å Supabase');
    return null;
  }

  try {
    supabase = supabaseModule.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: false
      },
      global: {
        headers: {
          'X-Client-Info': 'party-wall-tv/1.0'
        }
      },
      realtime: {
        params: {
          eventsPerSecond: 10
        }
      }
    });
    
    console.log('‚úÖ –ö–ª–∏–µ–Ω—Ç Supabase —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
    showStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'online', 3000);
    return supabase;
  } catch (err) {
    console.error('üí• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Supabase:', err);
    showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase!', 'error', 8000);
    return null;
  }
}

// 11. –ü–û–õ–£–ß–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –†–ï–ó–ï–†–í–ù–´–ú –í–ê–†–ò–ê–ù–¢–û–ú
async function fetchMessages() {
  try {
    lastDataUpdate = new Date().toISOString();
    lastUpdate.textContent = new Date().toLocaleTimeString();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    if (!updateConnectionStatus()) {
      console.warn('‚ö†Ô∏è –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
      return [...TEST_MESSAGES];
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
    if (modeTest.checked) {
      console.log('üîß –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
      return [...TEST_MESSAGES];
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (!supabase) {
      supabase = await initSupabase();
    }
    
    // –ï—Å–ª–∏ Supabase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    if (!supabase) {
      console.warn('‚ö†Ô∏è Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
      return [...TEST_MESSAGES];
    }
    
    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Supabase...');
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .eq('approved', true)
      .order('timestamp', { ascending: false })
      .limit(20);
    
    if (error) {
      throw error;
    }
    
    if (!data || data.length === 0) {
      console.log('üì≠ –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
      return [...TEST_MESSAGES];
    }
    
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
    return data;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.', 'error', 5000);
    return [...TEST_MESSAGES];
  }
}

// 12. –£–°–¢–ê–ù–û–í–ö–ê REALTIME –ü–û–î–ü–ò–°–ö–ò –° –ó–ê–©–ò–¢–û–ô
function setupRealtime() {
  // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
  if (realtimeChannel && supabase) {
    try {
      supabase.removeChannel(realtimeChannel);
    } catch (e) {
      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞:', e);
    }
    realtimeChannel = null;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
  if (!supabase || !isOnline || modePolling.checked || modeTest.checked) {
    console.warn('‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å realtime-–ø–æ–¥–ø–∏—Å–∫—É: —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã');
    return;
  }
  
  try {
    console.log('üì° –£—Å—Ç–∞–Ω–æ–≤–∫–∞ realtime-–ø–æ–¥–ø–∏—Å–∫–∏...');
    
    realtimeChannel = supabase
      .channel('messages-channel')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'messages',
        filter: 'approved=eq.true'
      }, handleRealtimeMessage)
      .subscribe(handleSubscriptionStatus);
      
    console.log('‚úÖ Realtime-–ø–æ–¥–ø–∏—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    connectionStatus.textContent = 'Realtime';
    connectionStatus.className = 'connection-status realtime';
    connectionState.textContent = 'Realtime –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
    connectionState.style.color = '#4dc1ff';
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ realtime-–ø–æ–¥–ø–∏—Å–∫–∏:', error);
    showStatus('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ realtime-–ø–æ–¥–ø–∏—Å–∫–∏', 'error', 3000);
    connectionState.textContent = '–û—à–∏–±–∫–∞ realtime';
  }
}

// 13. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò REALTIME –°–û–ë–´–¢–ò–ô
function handleRealtimeMessage(payload) {
  console.log('üîî Realtime —Å–æ–±—ã—Ç–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', payload);
  
  const newRecord = payload.new || payload.record;
  if (!newRecord || !newRecord.approved) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—á–µ—Ä–µ–¥–∏
  const exists = queue.some(msg => msg.id === newRecord.id);
  if (exists) return;
  
  queue.unshift(newRecord); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –æ—á–µ—Ä–µ–¥–∏
  tickerEl.classList.remove('fade-out');
  
  // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (!showing) {
    nextMessage();
  }
  
  updateQueueUI();
}

function handleSubscriptionStatus(status) {
  console.log(`üì∂ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: ${status}`);
  
  if (status === 'SUBSCRIBED') {
    reconnectAttempts = 0;
    console.log('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è realtime');
    connectionStatus.textContent = 'Realtime';
    connectionStatus.className = 'connection-status realtime';
    connectionState.textContent = 'Realtime –∞–∫—Ç–∏–≤–µ–Ω';
    connectionState.style.color = '#4dc1ff';
  } else if (['TIMED_OUT', 'CHANNEL_ERROR', 'CLOSED'].includes(status)) {
    console.warn(`‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π: ${status}, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...`);
    connectionState.textContent = `–û—à–∏–±–∫–∞: ${status}`;
    connectionState.style.color = '#ff4d4d';
    setTimeout(reconnectRealtime, Math.min(10000, TIMINGS.reconnectDelay * (1 + reconnectAttempts)));
  }
}

function reconnectRealtime() {
  if (!isOnline || !supabase || modePolling.checked || modeTest.checked) return;
  
  reconnectAttempts++;
  console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${reconnectAttempts}...`);
  
  if (reconnectAttempts >= maxReconnectAttempts) {
    console.error('‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    setupPollingFallback();
    return;
  }
  
  setupRealtime();
}

// 14. –†–ï–ó–ï–†–í–ù–´–ô –ü–û–õ–õ–ò–ù–ì
function setupPollingFallback() {
  console.log('‚è±Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥');
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
  if (pollingInterval) clearInterval(pollingInterval);
  
  // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  const interval = parseInt(pollingIntervalInput.value) || 30;
  TIMINGS.defaultPollingInterval = interval * 1000;
  
  pollingInterval = setInterval(async () => {
    if (!isOnline || modeTest.checked) return;
    
    try {
      console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥...');
      const newMessages = await fetchMessages();
      
      if (newMessages.length > 0) {
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—á–µ—Ä–µ–¥–∏, –∏–∑–±–µ–≥–∞—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        const currentIds = new Set(queue.map(msg => msg.id));
        const filteredNew = newMessages.filter(msg => !currentIds.has(msg.id));
        
        if (filteredNew.length > 0) {
          queue = [...filteredNew, ...queue].slice(0, 50); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
          console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${filteredNew.length} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ø–æ–ª–ª–∏–Ω–≥`);
          
          if (!showing) {
            nextMessage();
          }
          
          updateQueueUI();
        }
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ª–ª–∏–Ω–≥–µ:', error);
    }
  }, TIMINGS.defaultPollingInterval);
  
  connectionStatus.textContent = 'Polling';
  connectionStatus.className = 'connection-status online';
  connectionState.textContent = `–ü–æ–ª–ª–∏–Ω–≥ (${interval} —Å–µ–∫)`;
  connectionState.style.color = '#ffb86b';
}

// 15. –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô
function startMarquee(item) {
  console.log('üóûÔ∏è –ó–∞–ø—É—Å–∫ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏');
  
  const rawText = (item.text || '').trim();
  if (rawText.length < 6) {
    console.warn('‚úâÔ∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', rawText);
    return;
  }

  const text = `${esc(item.author || '–ê–Ω–æ–Ω–∏–º')}: ${esc(rawText)}`;
  marquee.innerHTML = text;
  marquee.style.animation = 'none';
  marquee.style.transform = '';
  marquee.classList.remove('initial');

  requestAnimationFrame(() => {
    const cw = marquee.scrollWidth;
    const vw = marqueeWrap.clientWidth;
    
    const spd = TIMINGS.marqueePixelsPerSec;
    const minDuration = (vw * 2) / spd;
    const fullDuration = (cw + vw * 2) / spd;
    const dur = Math.max(TIMINGS.marqueeMinDuration, minDuration * 1.5, fullDuration * 0.8);
    
    const st = document.getElementById('marqStyle') || (() => {
      let s = document.createElement('style');
      s.id = 'marqStyle';
      document.head.appendChild(s);
      return s;
    })();

    st.textContent = `
      @keyframes move {
        0%    { transform: translateX(${vw}px); }
        92%   { transform: translateX(-${cw}px); }
        100%  { transform: translateX(${vw}px); }
      }
    `;
    
    marquee.style.animation = `move ${dur}s ease-in-out infinite`;
  });
}

function showMessage(item, textOnly = false) {
  currentMessage = item;
  
  const rawText = (item.text || '').trim();
  if (rawText.length < 6) {
    console.warn('‚úâÔ∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', rawText);
    nextMessage(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    return;
  }

  const text = `${esc(item.author || '–ê–Ω–æ–Ω–∏–º')}: ${esc(rawText)}`;
  marquee.classList.add('initial');
  marquee.innerHTML = text;
  tickerEl.classList.remove('fade-out');

  if (textOnly) {
    console.log('üí¨ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);
    
    const getTextDisplayDuration = () => {
      const tempEl = document.createElement('div');
      tempEl.style.position = 'absolute';
      tempEl.style.visibility = 'hidden';
      tempEl.style.whiteSpace = 'nowrap';
      tempEl.style.fontSize = '28px';
      tempEl.style.fontWeight = '700';
      tempEl.style.padding = '0 40px';
      tempEl.innerHTML = text;
      document.body.appendChild(tempEl);
      
      const textWidth = tempEl.scrollWidth;
      const containerWidth = marqueeWrap.clientWidth;
      document.body.removeChild(tempEl);
      
      const calculatedTime = (textWidth + containerWidth * 2) / TIMINGS.marqueePixelsPerSec * 1000;
      return Math.min(15000, Math.max(5000, calculatedTime));
    };

    startMarquee(item);
    const textDisplayTime = getTextDisplayDuration();
    console.log(`‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ —Ç–µ–∫—Å—Ç–∞: ${textDisplayTime}ms`);
    
    setTimeout(() => {
      marquee.style.animation = 'none';
      setTimeout(() => {
        marquee.innerHTML = '&nbsp;';
        showing = false;
        currentMessage = null;
        nextMessage();
      }, 300);
    }, textDisplayTime);
    
    showing = true;
    updateQueueUI();
    return;
  }

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
  photoCard.classList.remove('hidden');
  photoCard.classList.add('preload');

  const frame = document.querySelector('.photo-frame');
  frame.style.width = '';
  frame.style.height = '';
  frame.classList.remove('drifting');

  mainPhoto.style.visibility = 'hidden';
  mainPhoto.style.opacity = '0';
  mainPhoto.src = item.image_url;

  const onLoaded = () => {
    console.log('üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
    
    const style = getComputedStyle(frame);
    const paddingX = parseFloat(style.paddingLeft || 0) + parseFloat(style.paddingRight || 0);
    const paddingY = parseFloat(style.paddingTop || 0) + parseFloat(style.paddingBottom || 0);
    const borderX = parseFloat(style.borderLeftWidth || 0) + parseFloat(style.borderRightWidth || 0);
    const borderY = parseFloat(style.borderTopWidth || 0) + parseFloat(style.borderBottomWidth || 0);

    const availableW = Math.max(40, photoCard.clientWidth - (paddingX + borderX));
    const availableH = Math.max(40, photoCard.clientHeight - (paddingY + borderY));

    const natW = mainPhoto.naturalWidth || availableW;
    const natH = mainPhoto.naturalHeight || availableH;
    const ratio = natW / natH || 1;

    let imgW = availableW;
    let imgH = Math.round(imgW / ratio);
    if (imgH > availableH) {
      imgH = availableH;
      imgW = Math.round(imgH * ratio);
    }

    const frameW = imgW + paddingX + borderX;
    const frameH = imgH + paddingY + borderY;

    frame.style.width = Math.max(frameW, parseFloat(getComputedStyle(frame).minWidth) || 0) + 'px';
    frame.style.height = Math.max(frameH, parseFloat(getComputedStyle(frame).minHeight) || 0) + 'px';

    photoCard.classList.remove('preload');

    // CRT —ç—Ñ—Ñ–µ–∫—Ç
    frame.style.animation = `crt-flicker ${TIMINGS.crtFlickerDuration}s steps(1) forwards`;
    mainPhoto.style.visibility = 'visible';

    setTimeout(() => {
      mainPhoto.style.opacity = '0.9';
      frame.style.animation = '';
      frame.classList.add('drifting');

      messageCounter++;
      const isEven = messageCounter % 2 === 0;
      const inAnim = isEven ? 'slideInRight' : 'slideInLeft';
      const outAnim = isEven ? 'slideOutLeft' : 'slideOutRight';

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      photoCard.style.animation = `${inAnim} ${TIMINGS.slideInDuration}s cubic-bezier(0.22, 0.61, 0.36, 1) forwards`;
      photoCard.classList.add('animating');

      setTimeout(() => {
        startMarquee(item);
      }, TIMINGS.startMarqueeDelay);

      // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–∞–Ω–∏—è
      setTimeout(() => {
        photoCard.style.animation = `${outAnim} ${TIMINGS.slideOutDuration}s cubic-bezier(0.55, 0.09, 0.68, 0.53) forwards`;
        setTimeout(() => {
          photoCard.classList.remove('animating');
          photoCard.classList.add('hidden');
          mainPhoto.src = '';
          showing = false;
          currentMessage = null;
          nextMessage();
        }, TIMINGS.slideOutDuration * 1000);
      }, TIMINGS.photoDisplayTime);
    }, TIMINGS.crtFlickerDuration * 1000);

    cleanup();
  };

  const onError = (e) => {
    console.error('üî• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
    cleanup();
    showMessage(item, true); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  };

  const cleanup = () => {
    mainPhoto.removeEventListener('load', onLoaded);
    mainPhoto.removeEventListener('error', onError);
  };

  mainPhoto.addEventListener('load', onLoaded);
  mainPhoto.addEventListener('error', onError);

  if (mainPhoto.complete && mainPhoto.naturalWidth) {
    setTimeout(onLoaded, 0);
  }

  showing = true;
  updateQueueUI();
}

function nextMessage() {
  console.log(`‚è≠Ô∏è –°–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—á–µ—Ä–µ–¥—å: ${queue.length}, –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: ${showing}`);
  
  if (showing) return;
  if (queue.length === 0) {
    console.log('‚èπÔ∏è –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
    queue = [...TEST_MESSAGES];
    tickerEl.classList.remove('fade-out');
    updateQueueUI();
  }

  const item = queue.shift();
  if (!item) {
    tickerEl.classList.add('fade-out');
    updateQueueUI();
    return;
  }

  const rawText = (item.text || '').trim();
  if (rawText.length < 6) {
    console.log('‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
    nextMessage(); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
    return;
  }

  console.log('‚û°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', item.id || '–±–µ–∑ ID');
  const hasImage = item.image_url && item.image_url.trim() && item.image_url.toLowerCase().startsWith('http');
  
  showMessage(item, !hasImage);
}

// 16. –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–ê–°–¢–†–û–ï–ö
function updateQueueUI() {
  queueCount.textContent = queue.length;
  
  queueList.innerHTML = '';
  
  if (currentMessage) {
    const currentItem = document.createElement('div');
    currentItem.className = 'queue-item current-item';
    currentItem.innerHTML = `
      <div class="queue-author">üî• –¢–ï–ö–£–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï</div>
      <div class="queue-text">${esc(currentMessage.author || '–ê–Ω–æ–Ω–∏–º')}: ${esc((currentMessage.text || '').substring(0, 80))}...</div>
    `;
    queueList.appendChild(currentItem);
  }
  
  queue.forEach((item, index) => {
    const queueItem = document.createElement('div');
    queueItem.className = 'queue-item';
    queueItem.innerHTML = `
      <div class="queue-author">${esc(item.author || '–ê–Ω–æ–Ω–∏–º')}</div>
      <div class="queue-text">${esc((item.text || '').substring(0, 80))}...</div>
      <div class="queue-controls">
        <button class="queue-btn skip-btn" data-index="${index}">‚è≠Ô∏è</button>
        <button class="queue-btn delete-btn" data-index="${index}">‚ùå</button>
      </div>
    `;
    queueList.appendChild(queueItem);
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
  document.querySelectorAll('.skip-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(btn.getAttribute('data-index'));
      if (index === 0 && showing) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        skipCurrentMessage();
      } else if (index === 0) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏
        queue.shift();
        nextMessage();
      } else {
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
        const item = queue.splice(index, 1)[0];
        queue.push(item);
      }
      updateQueueUI();
    });
  });
  
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const index = parseInt(btn.getAttribute('data-index'));
      queue.splice(index, 1);
      updateQueueUI();
    });
  });
}

function updateSettingsUI() {
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  connectionState.textContent = isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω';
  connectionState.style.color = isOnline ? '#4dff4d' : '#ff4d4d';
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º
  if (modeTest.checked) {
    currentMode.textContent = '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ';
    currentMode.style.color = '#ffb86b';
  } else if (modePolling.checked) {
    currentMode.textContent = '–¢–æ–ª—å–∫–æ –ø–æ–ª–ª–∏–Ω–≥';
    currentMode.style.color = '#4dc1ff';
  } else {
    currentMode.textContent = 'Realtime (–∞–≤—Ç–æ)';
    currentMode.style.color = '#ff6b96';
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
  updateQueueUI();
}

function skipCurrentMessage() {
  console.log('‚è≠Ô∏è –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
  
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é
  marquee.style.animation = 'none';
  marquee.innerHTML = '&nbsp;';
  
  if (photoCard.classList.contains('animating') || !photoCard.classList.contains('hidden')) {
    photoCard.style.animation = '';
    photoCard.classList.remove('animating');
    photoCard.classList.add('hidden');
    mainPhoto.src = '';
  }
  
  showing = false;
  currentMessage = null;
  nextMessage();
}

function applyConnectionMode() {
  // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  if (realtimeChannel && supabase) {
    try {
      supabase.removeChannel(realtimeChannel);
    } catch (e) {
      console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞:', e);
    }
    realtimeChannel = null;
  }
  
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
  
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º
  if (modeTest.checked) {
    console.log('üîß –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
    queue = [...TEST_MESSAGES];
    if (!showing) nextMessage();
  } else if (modePolling.checked) {
    console.log('üîß –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º –ø–æ–ª–ª–∏–Ω–≥–∞');
    setupPollingFallback();
  } else {
    console.log('üîß –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º realtime');
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    fetchMessages().then(data => {
      queue = data;
      if (!showing && queue.length > 0) {
        nextMessage();
      }
      updateQueueUI();
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º realtime
    if (supabase) {
      setupRealtime();
    }
  }
  
  updateSettingsUI();
}

function reloadData() {
  showStatus('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'warning', 0);
  
  fetchMessages().then(data => {
    queue = data;
    lastDataUpdate = new Date().toISOString();
    lastUpdate.textContent = new Date().toLocaleTimeString();
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'online', 3000);
    
    if (!showing && queue.length > 0) {
      nextMessage();
    }
    
    updateQueueUI();
  }).catch(error => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    showStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö!', 'error', 5000);
  });
}

// 17. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
async function initializeApp() {
  console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
  showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'warning', 0);
  
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    updateConnectionStatus();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    queue = await fetchMessages();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase –¥–ª—è realtime
    supabase = await initSupabase();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º realtime-–ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø–æ–ª–ª–∏–Ω–≥
    if (supabase && !modePolling.checked && !modeTest.checked) {
      setupRealtime();
    } else {
      setupPollingFallback();
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    setTimeout(() => {
      statusIndicator.style.display = 'none';
      if (queue.length > 0) {
        nextMessage();
      } else {
        tickerEl.classList.add('fade-out');
        showStatus('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning', 3000);
      }
      updateSettingsUI();
    }, 1500);
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏
    setInterval(() => {
      if (!showing && queue.length === 0) {
        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è)');
        fetchMessages().then(newMessages => {
          if (newMessages.length > 0) {
            queue = newMessages;
            nextMessage();
            updateQueueUI();
          }
        });
      }
    }, TIMINGS.nextMessageDelay);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (modePolling.checked || !supabase) {
      setupPollingFallback();
    }
    
  } catch (error) {
    console.error('üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    showStatus('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!', 'error', 0);
  }
}

// 18. –û–ë–†–ê–ë–û–¢–ö–ê –°–û–ë–´–¢–ò–ô –°–¢–†–ê–ù–ò–¶–´ –ò –°–ï–¢–ò
document.addEventListener('DOMContentLoaded', () => {
  console.log('‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
  channelLogo.addEventListener('click', () => {
    settingsModal.classList.add('active');
    updateSettingsUI();
  });
  
  closeSettings.addEventListener('click', () => {
    settingsModal.classList.remove('active');
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) {
      settingsModal.classList.remove('active');
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  modeRealtime.addEventListener('change', applyConnectionMode);
  modePolling.addEventListener('change', applyConnectionMode);
  modeTest.addEventListener('change', applyConnectionMode);
  
  pollingIntervalInput.addEventListener('change', () => {
    if (modePolling.checked) {
      setupPollingFallback();
    }
  });
  
  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  skipCurrentBtn.addEventListener('click', skipCurrentMessage);
  reloadDataBtn.addEventListener('click', reloadData);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  initializeApp();
});

window.addEventListener('online', () => {
  console.log('üåê –°–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  updateConnectionStatus();
  setTimeout(initializeApp, 2000);
});

window.addEventListener('offline', () => {
  console.warn('‚ö†Ô∏è –°–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
  updateConnectionStatus();
  showStatus('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!', 'error', 5000);
});

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
setInterval(updateConnectionStatus, 5000);
</script>
</body>
</html>
